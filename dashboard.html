<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SIL Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-blue-600 p-4 text-white flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold tracking-wide">Sistem Informasi Laboratorium</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <span id="userName" class="block font-medium text-sm">User</span>
                <span class="block text-xs text-blue-200">Mahasiswa/Dosen</span>
            </div>
            <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded text-sm font-bold hover:bg-red-600 transition shadow-sm">
                Logout
            </button>
        </div>
    </nav>

    <div class="container mx-auto p-6 max-w-7xl">

        <div class="mb-10">
            <div class="flex justify-between items-end mb-4 border-b pb-2 border-gray-200">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Status Ruangan Saat Ini</h2>
                    <p class="text-sm text-gray-500">Pantau ketersediaan laboratorium secara real-time</p>
                </div>
                <button onclick="loadRoomStatus()" class="text-blue-600 text-sm hover:underline flex items-center gap-1">
                    üîÑ Refresh Status
                </button>
            </div>
            
            <div id="roomStatusContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                <div class="animate-pulse bg-gray-200 h-32 rounded-lg"></div>
                <div class="animate-pulse bg-gray-200 h-32 rounded-lg"></div>
                <div class="animate-pulse bg-gray-200 h-32 rounded-lg"></div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-1 h-fit border border-gray-100">
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    üìù Ajukan Peminjaman
                </h2>
                <form id="bookingForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Ruangan</label>
                        <select id="ruangId" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50 transition" required>
                            <option value="" disabled selected>Memuat daftar ruangan...</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Mulai</label>
                            <input type="datetime-local" id="waktuMulai" class="w-full p-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Selesai</label>
                            <input type="datetime-local" id="waktuSelesai" class="w-full p-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan Peminjaman</label>
                        <textarea id="tujuan" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" rows="3" placeholder="Contoh: Praktikum Algoritma Kelas A" required></textarea>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition transform active:scale-95 shadow-md">
                        Kirim Pengajuan
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2 border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        üïí Riwayat Peminjaman Saya
                    </h2>
                    <button onclick="loadBookings()" class="text-sm text-blue-500 hover:text-blue-700 font-medium">
                        Refresh Data
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr class="text-gray-600 text-xs uppercase tracking-wider text-left">
                                <th class="py-3 px-4 font-semibold">Ruangan</th>
                                <th class="py-3 px-4 font-semibold">Waktu</th>
                                <th class="py-3 px-4 font-semibold text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTableBody" class="text-gray-600 text-sm divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const API_URL = 'https://sil-lab-backend.vercel.app/api';
        const token = localStorage.getItem('token');
        
        // Cek Login
        if (!token) window.location.href = '/'; 
        
        // Tampilkan Nama User
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').innerText = user.nama || user.email || 'User';

        // --- LOGIKA UTAMA: STATUS RUANGAN & FORM ---
        async function loadRoomStatus() {
            try {
                // 1. Ambil Daftar Ruangan
                const resRooms = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` }});
                const rooms = await resRooms.json();

                // 2. Ambil Jadwal Publik (Hanya yang statusnya 'disetujui')
                const resSchedule = await fetch(`${API_URL}/booking/schedule`, { headers: { 'Authorization': `Bearer ${token}` }});
                const schedules = await resSchedule.json();

                const container = document.getElementById('roomStatusContainer');
                const selectEl = document.getElementById('ruangId');
                
                // Reset UI
                container.innerHTML = '';
                selectEl.innerHTML = '<option value="" disabled selected>-- Pilih Ruangan --</option>';

                const now = new Date(); // Waktu sekarang di laptop user

                rooms.forEach(room => {
                    // A. Isi Dropdown Peminjaman
                    selectEl.innerHTML += `<option value="${room.id}">${room.nama_ruang} (Kapasitas: ${room.kapasitas})</option>`;

                    // B. Hitung Status Ruangan (Merah/Hijau)
                    // Cari apakah ada jadwal yang "menimpa" waktu sekarang
                    const currentBooking = schedules.find(sch => {
                        const start = new Date(sch.waktu_mulai);
                        const end = new Date(sch.waktu_selesai);
                        return sch.ruang_id === room.id && now >= start && now <= end;
                    });

                    // Default: Hijau (Tersedia)
                    let statusClass = 'bg-green-50 border-l-4 border-green-500';
                    let textColor = 'text-green-700';
                    let icon = '‚úÖ';
                    let statusText = 'TERSEDIA';
                    let detailText = 'Ruangan kosong';

                    // Jika Dipakai: Merah
                    if (currentBooking) {
                        statusClass = 'bg-red-50 border-l-4 border-red-500';
                        textColor = 'text-red-700';
                        icon = '‚õî';
                        statusText = 'SEDANG DIPAKAI';
                        const selesaiJam = new Date(currentBooking.waktu_selesai).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                        detailText = `Sampai jam ${selesaiJam}`;
                    }

                    // Render Kartu
                    const card = `
                        <div class="${statusClass} p-4 rounded-r-lg shadow-sm hover:shadow-md transition duration-300 flex flex-col justify-between h-32">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 truncate">${room.nama_ruang}</h3>
                                <p class="text-xs text-gray-500">${room.lokasi} ‚Ä¢ Kap: ${room.kapasitas}</p>
                            </div>
                            <div class="mt-3">
                                <div class="flex items-center gap-2 ${textColor} font-bold text-sm">
                                    <span>${icon}</span>
                                    <span>${statusText}</span>
                                </div>
                                <p class="text-xs text-gray-500 ml-6">${detailText}</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });

            } catch (error) {
                console.error('Error loading room status:', error);
                document.getElementById('roomStatusContainer').innerHTML = 
                    '<p class="text-red-500 col-span-3 text-center">Gagal memuat data ruangan. Pastikan backend berjalan.</p>';
            }
        }

        // --- LOGIKA RIWAYAT PEMINJAMAN ---
        async function loadBookings() {
            try {
                const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const tableBody = document.getElementById('bookingTableBody');
                tableBody.innerHTML = '';
                
                if(data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-400 italic">Belum ada riwayat peminjaman</td></tr>';
                    return;
                }

                data.forEach(booking => {
                    // Warna Badge Status
                    let badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    if(booking.status === 'disetujui') badgeClass = 'bg-green-100 text-green-800 border-green-200';
                    if(booking.status === 'ditolak') badgeClass = 'bg-red-100 text-red-800 border-red-200';
                    if(booking.status === 'selesai') badgeClass = 'bg-gray-100 text-gray-800 border-gray-200';

                    const start = new Date(booking.waktu_mulai).toLocaleString('id-ID', { 
                        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    const row = `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="py-3 px-4 font-medium text-gray-800">
                                ${booking.ruangan ? booking.ruangan.nama_ruang : 'ID: '+booking.ruang_id}
                            </td>
                            <td class="py-3 px-4 text-gray-600">${start}</td>
                            <td class="py-3 px-4 text-center">
                                <span class="${badgeClass} px-3 py-1 rounded-full text-xs font-bold border shadow-sm">
                                    ${booking.status.toUpperCase()}
                                </span>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (error) { console.error('Error loading bookings:', error); }
        }

        // --- LOGIKA SUBMIT FORM ---
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ambil nilai form
            const ruangId = document.getElementById('ruangId').value;
            const waktuMulai = document.getElementById('waktuMulai').value;
            const waktuSelesai = document.getElementById('waktuSelesai').value;
            const tujuan = document.getElementById('tujuan').value;

            if(!ruangId) { alert('Silakan pilih ruangan terlebih dahulu'); return; }

            const payload = {
                ruang_id: ruangId,
                waktu_mulai: new Date(waktuMulai).toISOString(),
                waktu_selesai: new Date(waktuSelesai).toISOString(),
                tujuan_peminjaman: tujuan
            };

            try {
                const res = await fetch(`${API_URL}/booking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    alert('‚úÖ Pengajuan Berhasil dikirim! Menunggu persetujuan Admin.');
                    document.getElementById('bookingForm').reset();
                    loadBookings();   // Refresh tabel
                    loadRoomStatus(); // Siapa tahu status berubah
                } else {
                    alert('‚ùå Gagal: ' + result.error);
                }
            } catch (error) { 
                alert('Terjadi kesalahan koneksi ke server.');
            }
        });

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Jalankan saat halaman pertama kali dibuka
        loadBookings();
        loadRoomStatus();
    </script>
</body>
</html>
