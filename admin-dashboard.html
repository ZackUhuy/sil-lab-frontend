<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SISIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Wajib -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden-row { display: none; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-transform { transition: transform 0.3s ease; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    <!-- NAVBAR -->
    <nav class="bg-gray-900 p-4 text-white flex justify-between items-center shadow-lg sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-xl tracking-wide">ADMIN PANEL SISIL</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <span id="adminName" class="block font-bold text-sm text-yellow-400">Admin</span>
                <span class="block text-xs text-gray-400">Administrator Mode</span>
            </div>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition font-medium shadow">Keluar</button>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        
        <!-- Navigasi Tab -->
        <div class="mb-6 bg-white rounded-lg shadow-sm p-1 flex flex-wrap gap-1">
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center bg-blue-600 text-white transition">
                üìä Dashboard
            </button>
            <button onclick="showTab('peminjaman')" id="tab-peminjaman" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üìÖ Jadwal
            </button>
            <button onclick="showTab('ruangan')" id="tab-ruangan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üè¢ Ruangan
            </button>
            <button onclick="showTab('peralatan')" id="tab-peralatan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üì¶ Alat
            </button>
            <button onclick="showTab('laporan')" id="tab-laporan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üõ†Ô∏è Kerusakan
            </button>
        </div>

        <!-- === TAB 0: DASHBOARD ANALITIK === -->
        <div id="content-dashboard" class="tab-content active">
            <!-- Statistik Angka -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="text-gray-500 text-xs font-bold uppercase">Total Peminjaman</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2" id="stat-total">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-500">
                    <div class="text-yellow-600 text-xs font-bold uppercase">Menunggu Persetujuan</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2" id="stat-pending">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                    <div class="text-red-600 text-xs font-bold uppercase">Laporan Kerusakan</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2" id="stat-damage">-</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                    <div class="text-green-600 text-xs font-bold uppercase">Total Aset Alat</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2" id="stat-tools">-</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Grafik Ruangan -->
                <div class="bg-white p-6 rounded-lg shadow border border-gray-100 lg:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">üè¢ Frekuensi Pemakaian Ruangan</h3>
                    <div class="relative h-72 w-full flex items-center justify-center bg-gray-50 rounded-lg">
                        <canvas id="roomChart"></canvas>
                        <p id="roomChartEmpty" class="hidden text-gray-400 text-sm italic">Belum ada data peminjaman.</p>
                    </div>
                </div>

                <!-- Grafik Alat & Export -->
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">üì¶ 5 Alat Terpopuler</h3>
                        <div class="relative h-48 w-full flex items-center justify-center bg-gray-50 rounded-lg">
                            <canvas id="toolChart"></canvas>
                            <p id="toolChartEmpty" class="hidden text-gray-400 text-sm italic">Belum ada data.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-3">Laporan & Export</h3>
                        <div class="space-y-3">
                            <button onclick="exportToCSV()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm font-bold flex justify-center items-center gap-2">
                                üìÑ Data Peminjaman (CSV)
                            </button>
                            <button onclick="exportEquipmentCSV()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm font-bold flex justify-center items-center gap-2">
                                üì¶ Data Inventaris (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 1: MANAJEMEN JADWAL (SAMA) -->
        <div id="content-peminjaman" class="tab-content"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200 sticky top-24"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Jadwal Manual</h3><form id="form-tambah-jadwal" class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ruangan <span class="text-red-500">*</span></label><select id="jadwal_ruang_id" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500" required><option value="">Memuat...</option></select></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai (Sesi 1)</label><input type="datetime-local" id="jadwal_mulai" class="w-full p-2 border rounded bg-gray-50 text-sm" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai (Sesi 1)</label><input type="datetime-local" id="jadwal_selesai" class="w-full p-2 border rounded bg-gray-50 text-sm" required></div></div><div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="flex items-center mb-2"><input type="checkbox" id="is_repeat" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" onchange="toggleRepeatInput()"><label for="is_repeat" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">Ulangi Jadwal (Mingguan)?</label></div><div id="repeat_input_container" class="hidden mt-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jumlah Minggu</label><input type="number" id="repeat_count" class="w-full p-2 border rounded bg-white text-sm" value="16" min="2" max="20" placeholder="Contoh: 16"><p class="text-xs text-gray-400 mt-1 italic">*Jadwal akan diduplikasi setiap 7 hari.</p></div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan Kegiatan</label><textarea id="jadwal_tujuan" class="w-full p-2 border rounded bg-gray-50 text-sm" rows="2" placeholder="Contoh: Kuliah Algoritma A" required></textarea></div><button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium shadow transition">Simpan Jadwal</button></form></div><div class="lg:col-span-2 space-y-6"><div class="bg-white rounded-lg shadow overflow-hidden border border-yellow-200"><div class="p-4 bg-yellow-50 border-b border-yellow-200 flex justify-between items-center"><h3 class="font-bold text-yellow-800 flex items-center gap-2">üîî Permintaan Masuk (Pending)</h3><button onclick="loadAllBookings()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh</button></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50 text-gray-600 text-xs uppercase"><tr><th class="py-2 px-4 text-left">User</th><th class="py-2 px-4 text-left">Info Peminjaman</th><th class="py-2 px-4 text-center">Aksi</th></tr></thead><tbody id="pendingTableBody" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div><div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200"><div class="p-4 bg-gray-50 border-b border-gray-200"><h3 class="font-bold text-gray-700">üìÖ Jadwal Terkonfirmasi (Per Kelas/Kegiatan)</h3></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0"><tr><th class="py-3 px-4 text-left w-10"></th><th class="py-3 px-4 text-left">Nama Kegiatan</th><th class="py-3 px-4 text-left">Ruangan / Status</th><th class="py-3 px-4 text-left">Mulai</th><th class="py-3 px-4 text-center">Aksi</th></tr></thead><tbody id="approvedTableBody" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div></div></div></div>

        <!-- TAB 2: RUANGAN (SAMA) -->
        <div id="content-ruangan" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Ruangan</h3><form id="form-tambah-ruang" class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Ruang</label><input type="text" id="nama_ruang" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label><input type="number" id="kapasitas" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label><input type="text" id="lokasi" class="w-full p-2 border rounded bg-gray-50" required></div><button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-medium shadow">Simpan Ruangan</button></form></div><div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200"><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="py-3 px-6 text-left font-bold">Ruangan</th><th class="py-3 px-6 text-left font-bold">Status</th><th class="py-3 px-6 text-center font-bold">Aksi</th></tr></thead><tbody id="table-ruangan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div></div>

        <!-- TAB 3: PERALATAN (SAMA) -->
        <div id="content-peralatan" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Alat</h3><form id="form-tambah-peralatan" class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Alat</label><input type="text" id="nama_alat" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label><input type="text" id="kategori" class="w-full p-2 border rounded bg-gray-50" required></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Stok</label><input type="number" id="jumlah_total" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label><select id="kondisi" class="w-full p-2 border rounded bg-gray-50"><option value="baik">Baik</option><option value="rusak">Rusak</option><option value="maintenance">Maintenance</option></select></div></div><button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 font-medium shadow">Simpan Alat</button></form></div><div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200"><div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-gray-700">üì¶ Monitoring Stok Alat</h3><button onclick="loadPeralatan()" class="text-blue-600 text-sm hover:underline">üîÑ Refresh Stok</button></div><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="py-3 px-6 text-left font-bold">Nama Alat</th><th class="py-3 px-6 text-center font-bold">Total</th><th class="py-3 px-6 text-center font-bold">Dipinjam</th><th class="py-3 px-6 text-center font-bold">Sisa</th><th class="py-3 px-6 text-center font-bold">Aksi</th></tr></thead><tbody id="table-peralatan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div></div>

        <!-- TAB 4: LAPORAN (SAMA) -->
        <div id="content-laporan" class="tab-content"><div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200"><div class="p-5 border-b bg-gray-50 flex justify-between items-center"><div><h3 class="text-lg font-bold text-red-800">Daftar Laporan Kerusakan</h3><p class="text-xs text-gray-500">Pantau dan update status perbaikan alat di sini.</p></div><button onclick="loadReports()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh Data</button></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="py-3 px-6 text-left font-bold">Tanggal</th><th class="py-3 px-6 text-left font-bold">Pelapor</th><th class="py-3 px-6 text-left font-bold">Nama Alat</th><th class="py-3 px-6 text-left font-bold">Deskripsi Masalah</th><th class="py-3 px-6 text-center font-bold">Update Status</th></tr></thead><tbody id="table-reports-body" class="text-gray-700 text-sm divide-y divide-gray-100"></tbody></table></div></div></div>
    </div>

    <!-- MODALS (SAMA) -->
    <div id="borrowerModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"><div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeBorrowerModal()"></div><div class="bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto p-6"><div class="flex justify-between mb-4 border-b pb-2"><h3 class="text-lg font-bold text-gray-800" id="modalToolName">Detail Peminjam</h3><button onclick="closeBorrowerModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button></div><div id="borrowerList" class="space-y-2 text-sm"></div></div></div>
    <div id="scheduleModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"><div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div><div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[80vh] p-6"><div class="flex justify-between mb-4 border-b pb-2"><h3 class="text-lg font-bold text-gray-800" id="modalRoomName">Jadwal</h3><button onclick="toggleModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button></div><ul id="modalScheduleList" class="space-y-2 text-sm"></ul><p id="modalEmpty" class="text-center text-gray-400 text-sm hidden">Tidak ada jadwal aktif.</p></div></div>
    <div id="editRoomModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"><div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeEditRoomModal()"></div><div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto p-6"><h3 class="text-lg font-bold text-gray-800 mb-4">Edit Ruangan</h3><form id="form-edit-ruangan"><input type="hidden" id="edit_room_id"><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Ruang</label><input type="text" id="edit_nama_ruang" class="w-full p-2 border rounded bg-gray-50" required></div><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label><input type="number" id="edit_kapasitas" class="w-full p-2 border rounded bg-gray-50" required></div><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label><input type="text" id="edit_lokasi" class="w-full p-2 border rounded bg-gray-50" required></div><div class="flex justify-end gap-2"><button type="button" onclick="closeEditRoomModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    <div id="editToolModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"><div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeEditToolModal()"></div><div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto p-6"><h3 class="text-lg font-bold text-gray-800 mb-4">Edit Stok & Info Alat</h3><form id="form-edit-alat"><input type="hidden" id="edit_alat_id"><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Alat</label><input type="text" id="edit_nama_alat" class="w-full p-2 border rounded bg-gray-50" required></div><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label><input type="text" id="edit_kategori" class="w-full p-2 border rounded bg-gray-50" required></div><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Stok</label><input type="number" id="edit_jumlah_total" class="w-full p-2 border rounded bg-gray-50" required></div><div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label><select id="edit_kondisi" class="w-full p-2 border rounded bg-gray-50"><option value="baik">Baik</option><option value="rusak">Rusak</option><option value="maintenance">Maintenance</option></select></div><div class="flex justify-end gap-2"><button type="button" onclick="closeEditToolModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>

    <script>
        const API_URL = 'https://sil-lab-backend.vercel.app/api'; 
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!token || user.role !== 'admin') { alert('Akses Ditolak!'); window.location.href = 'index.html'; }
        document.getElementById('adminName').innerText = user.nama || user.email || 'Admin';

        // --- EXPORT CSV (FIXED: Support Alat) ---
        function exportToCSV() {
            fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } }).then(res => res.json()).then(data => {
                let csv = "data:text/csv;charset=utf-8,Nama Peminjam,Role,Ruangan,Alat,Tujuan,Mulai,Selesai,Status\n";
                data.forEach(r => {
                    // Gabungkan nama alat
                    let tools = '-';
                    if (r.peminjaman_detail_alat && r.peminjaman_detail_alat.length > 0) {
                        tools = r.peminjaman_detail_alat.map(t => `${t.jumlah_pinjam}x ${t.peralatan?.nama_alat}`).join('; ').replace(/,/g, ' ');
                    }
                    
                    const userName = (r.users?.nama || 'Admin').replace(/,/g, ' ');
                    const role = r.users?.role || '-';
                    const room = (r.ruangan?.nama_ruang || 'Hanya Alat').replace(/,/g, ' ');
                    const purpose = (r.tujuan_peminjaman || '').replace(/,/g, ' ').replace(/\n/g, ' ');
                    const start = new Date(r.waktu_mulai).toLocaleString().replace(',', '');
                    const end = new Date(r.waktu_selesai).toLocaleString().replace(',', '');

                    csv += `${userName},${role},${room},${tools},${purpose},${start},${end},${r.status}\n`;
                });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "laporan_peminjaman.csv"); document.body.appendChild(link); link.click();
            });
        }

        function exportEquipmentCSV() {
            fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } }).then(res => res.json()).then(data => {
                let csv = "data:text/csv;charset=utf-8,Nama Alat,Kategori,Total Stok,Stok Tersedia,Kondisi\n";
                data.forEach(r => { csv += `${r.nama_alat},${r.kategori},${r.jumlah_total},${r.jumlah_tersedia},${r.kondisi}\n`; });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "laporan_alat.csv"); document.body.appendChild(link); link.click();
            });
        }

        async function loadAnalytics() {
            // ... (Sama seperti sebelumnya) ...
            try {
                const res = await fetch(`${API_URL}/analytics`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                document.getElementById('stat-total').innerText = data.totalBookings;
                document.getElementById('stat-pending').innerText = data.pendingBookings;
                document.getElementById('stat-damage').innerText = data.damageReports;
                document.getElementById('stat-tools').innerText = data.totalTools;
                // Chart Ruangan
                const roomLabels = [], roomCounts = {}, roomMap = {};
                if (data.roomUsage && data.roomUsage.length > 0) {
                    data.roomUsage.forEach(i => { const n = i.ruangan ? i.ruangan.nama_ruang : 'Tanpa Ruangan'; roomMap[n] = (roomMap[n]||0)+1; });
                    for (const k in roomMap) { roomLabels.push(k); roomCounts[k]=roomMap[k]; }
                    if(window.roomChartInstance) window.roomChartInstance.destroy();
                    document.getElementById('roomChartEmpty').classList.add('hidden');
                    const ctx = document.getElementById('roomChart').getContext('2d');
                    window.roomChartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(roomMap), datasets: [{ label: 'Peminjaman', data: Object.values(roomMap), backgroundColor: '#3B82F6' }] }, options: { responsive: true, maintainAspectRatio: false, scales: {y:{beginAtZero:true, ticks:{stepSize:1}}} } });
                } else { document.getElementById('roomChartEmpty').classList.remove('hidden'); }
                // Chart Alat
                const toolLabels = [], toolCounts = [];
                if (data.toolUsage && data.toolUsage.length > 0) {
                     const toolMap = {}; data.toolUsage.forEach(t => { const n = t.peralatan?.nama_alat || 'Unknown'; toolMap[n] = (toolMap[n]||0) + t.jumlah_pinjam; });
                     const sorted = Object.entries(toolMap).sort(([,a],[,b])=>b-a).slice(0,5);
                     sorted.forEach(([n,c])=>{ toolLabels.push(n); toolCounts.push(c); });
                     if(window.toolChartInstance) window.toolChartInstance.destroy();
                     document.getElementById('toolChartEmpty').classList.add('hidden');
                     const ctxT = document.getElementById('toolChart').getContext('2d');
                     window.toolChartInstance = new Chart(ctxT, { type: 'doughnut', data: { labels: toolLabels, datasets: [{ data: toolCounts, backgroundColor: ['#F59E0B','#10B981','#EF4444','#3B82F6','#8B5CF6'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                } else { document.getElementById('toolChartEmpty').classList.remove('hidden'); }
            } catch(e) { console.log(e); }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('bg-blue-600', 'text-white'); b.classList.add('text-gray-600', 'hover:bg-gray-100'); });
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:bg-gray-100');
            if(tabName==='dashboard') loadAnalytics();
        }

        // ... (Sisa Fungsi Helper, Loaders, Handlers SAMA PERSIS) ...
        // Saya singkat agar muat, tapi fungsionalitasnya tetap
        async function deleteItem(e,i,m,f){if(confirm(m))try{const r=await fetch(`${API_URL}/${e}/${i}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});if(r.ok){alert('Dihapus!');f()}else alert('Gagal')}catch(x){alert(x.message)}}
        function toggleRepeatInput(){const c=document.getElementById('is_repeat').checked;document.getElementById('repeat_input_container').className=c?'mt-2':'hidden mt-2'}
        async function loadRuangOptions(){const r=await fetch(`${API_URL}/rooms`,{headers:{'Authorization':`Bearer ${token}`}});const d=await r.json();const s=document.getElementById('jadwal_ruang_id');s.innerHTML='<option value="">-- Pilih Ruangan --</option>';d.forEach(x=>{if(x.status!=='maintenance')s.innerHTML+=`<option value="${x.id}">${x.nama_ruang}</option>`})}
        async function loadAllBookings(){
            const r=await fetch(`${API_URL}/booking`,{headers:{'Authorization':`Bearer ${token}`}});const d=await r.json();
            const pb=document.getElementById('pendingTableBody');const ab=document.getElementById('approvedTableBody');
            pb.innerHTML='';ab.innerHTML='';
            const pd=d.filter(i=>i.status==='pending');const ad=d.filter(i=>i.status!=='pending');
            if(pd.length===0)pb.innerHTML='<tr><td colspan="3" class="p-3 text-center italic text-gray-400">Tidak ada data</td></tr>';
            pd.forEach(i=>{
                let info=i.ruangan?`<div class="font-bold text-blue-600">üìç ${i.ruangan.nama_ruang}</div>`:`<div class="font-bold text-purple-600">üì¶ Alat Saja</div>`;
                if(i.peminjaman_detail_alat?.length>0) info+=`<div class="text-xs text-gray-500 mt-1">Alat: ${i.peminjaman_detail_alat.map(t=>t.jumlah_pinjam+'x '+t.peralatan?.nama_alat).join(', ')}</div>`;
                pb.innerHTML+=`<tr class="bg-yellow-50 border-b border-yellow-100"><td class="p-3"><div class="font-bold text-gray-800">${i.users?.nama||'User'}</div><div class="text-xs text-gray-500">${i.tujuan_peminjaman}</div></td><td class="p-3 text-xs">${info}<div class="mt-1 text-gray-600">üìÖ ${new Date(i.waktu_mulai).toLocaleString()}</div></td><td class="p-3 text-center space-x-1"><button onclick="updateStatus('${i.id}','disetujui')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì</button><button onclick="updateStatus('${i.id}','ditolak')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">‚úï</button></td></tr>`;
            });
            const g={};ad.forEach(i=>{const b=i.tujuan_peminjaman.split(' (Pert.')[0];const k=b+'_'+(i.ruang_id||'tool');if(!g[k])g[k]=[];g[k].push(i)});
            for(const k in g){
                const its=g[k];its.sort((a,b)=>new Date(a.waktu_mulai)-new Date(b.waktu_mulai));
                const f=its[0];const bn=f.tujuan_peminjaman.split(' (Pert.')[0];const gid='g-'+Math.random().toString(36).substr(2,9);
                let h='‚ö†Ô∏è Tanpa Ruangan';if(f.ruangan)h=f.ruangan.nama_ruang;else if(f.peminjaman_detail_alat?.length>0)h='üì¶ Alat Saja';
                ab.innerHTML+=`<tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" onclick="toggleGroup('${gid}')"><td class="p-3 text-center text-gray-400 font-bold text-lg transition-transform transform" id="icon-${gid}">‚ñ∂</td><td class="p-3 font-bold text-gray-800">${bn}<span class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full border border-blue-200">${its.length} Sesi</span></td><td class="p-3 text-sm text-gray-600">${h}</td><td class="p-3 text-xs text-gray-500">${new Date(its[0].waktu_mulai).toLocaleDateString()}</td><td class="p-3 text-center"><button onclick="event.stopPropagation();deleteBatch('${bn}','${f.ruang_id||'null'}')" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded bg-red-50">Hapus Semua</button></td></tr>`;
                let c=`<tr id="${gid}" class="hidden-row bg-gray-50 shadow-inner"><td colspan="5" class="p-0"><table class="w-full">`;
                its.forEach(s=>{let ti=s.peminjaman_detail_alat?.length>0?`<br><span class="text-gray-400 italic">Alat: ${s.peminjaman_detail_alat.map(t=>t.jumlah_pinjam+'x '+t.peralatan?.nama_alat).join(', ')}</span>`:'';c+=`<tr class="border-b border-gray-200 text-xs text-gray-600 hover:bg-gray-100"><td class="p-3 pl-12 w-1/3 font-medium">${s.tujuan_peminjaman} ${ti}</td><td class="p-3">${new Date(s.waktu_mulai).toLocaleString()}</td><td class="p-3 text-center w-24"><button onclick="deleteItem('booking','${s.id}','Hapus?',loadAllBookings)" class="text-red-400 hover:text-red-600 underline">Hapus</button></td></tr>`});
                ab.innerHTML+=c+`</table></td></tr>`;
            }
        }
        function toggleGroup(id){const r=document.getElementById(id);const i=document.getElementById('icon-'+id);if(r.classList.contains('hidden-row')){r.classList.remove('hidden-row');i.style.transform='rotate(90deg)'}else{r.classList.add('hidden-row');i.style.transform='rotate(0deg)'}}
        async function deleteBatch(c,r){if(!confirm('Hapus SEMUA?'))return;const rs=await fetch(`${API_URL}/booking`,{headers:{'Authorization':`Bearer ${token}`}});const d=await rs.json();const td=d.filter(i=>{const n=i.tujuan_peminjaman.split(' (Pert.')[0];const ir=i.ruang_id||'null';return n===c&&ir===r&&i.status!=='pending'});for(const x of td)await fetch(`${API_URL}/booking/${x.id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});alert('Sukses');loadAllBookings()}
        async function handleTambahJadwal(e){e.preventDefault();const rid=document.getElementById('jadwal_ruang_id').value;if(!rid){alert('Pilih Ruangan!');return}const p={ruang_id:rid,waktu_mulai:new Date(document.getElementById('jadwal_mulai').value).toISOString(),waktu_selesai:new Date(document.getElementById('jadwal_selesai').value).toISOString(),tujuan_peminjaman:document.getElementById('jadwal_tujuan').value,is_repeat:document.getElementById('is_repeat').checked,repeat_count:document.getElementById('is_repeat').checked?parseInt(document.getElementById('repeat_count').value):1};const b=e.target.querySelector('button');const o=b.innerText;b.innerText='...';b.disabled=true;try{const r=await fetch(`${API_URL}/booking/admin`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(p)});const j=await r.json();if(r.ok){alert('Sukses');e.target.reset();loadAllBookings()}else alert(j.error)}catch(x){alert(x.message)}finally{b.innerText=o;b.disabled=false}}
        async function updateStatus(i,s){await fetch(`${API_URL}/booking/${i}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status:s})});loadAllBookings()}
        async function loadRuangan(){const r=await fetch(`${API_URL}/rooms`,{headers:{'Authorization':`Bearer ${token}`}});const d=await r.json();document.getElementById('table-ruangan-body').innerHTML=d.map(i=>`<tr class="border-b hover:bg-gray-50"><td class="py-3 px-6 font-bold text-gray-800">${i.nama_ruang}</td><td class="py-3 px-6">${i.status==='maintenance'?'<span class="bg-orange-100 text-orange-800 px-2 rounded text-xs">MTC</span>':'<span class="bg-green-100 text-green-800 px-2 rounded text-xs">OK</span>'}</td><td class="py-3 px-6 text-center"><div class="flex justify-center space-x-2"><button onclick="showRoomSchedule('${i.id}','${i.nama_ruang}')" class="text-blue-600 text-xs underline">Jadwal</button><button onclick="setMaintenance('${i.id}','${i.status==='maintenance'?'tersedia':'maintenance'}')" class="text-orange-500 text-xs underline">Status</button><button onclick="openEditRoomModal('${i.id}','${i.nama_ruang}','${i.kapasitas}','${i.lokasi}')" class="text-blue-600 text-xs font-bold border border-blue-200 px-2 py-1 rounded hover:bg-blue-50">Edit</button><button onclick="deleteItem('rooms','${i.id}','Hapus?',loadRuangan)" class="text-red-500 text-lg">&times;</button></div></td></tr>`).join('')}
        async function setMaintenance(id,s){if(confirm('Ubah?'))await fetch(`${API_URL}/rooms/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status:s})});loadRuangan();loadRuangOptions()}
        async function handleTambahRuang(e){e.preventDefault();await fetch(`${API_URL}/rooms`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({nama_ruang:document.getElementById('nama_ruang').value,kapasitas:document.getElementById('kapasitas').value,lokasi:document.getElementById('lokasi').value})});e.target.reset();loadRuangan();loadRuangOptions()}
        function openEditRoomModal(id,n,k,l){document.getElementById('edit_room_id').value=id;document.getElementById('edit_nama_ruang').value=n;document.getElementById('edit_kapasitas').value=k;document.getElementById('edit_lokasi').value=l;document.getElementById('editRoomModal').classList.remove('hidden')}
        function closeEditRoomModal(){document.getElementById('editRoomModal').classList.add('hidden')}
        document.getElementById('form-edit-ruangan').addEventListener('submit',async(e)=>{e.preventDefault();const id=document.getElementById('edit_room_id').value;const p={nama_ruang:document.getElementById('edit_nama_ruang').value,kapasitas:document.getElementById('edit_kapasitas').value,lokasi:document.getElementById('edit_lokasi').value};try{const r=await fetch(`${API_URL}/rooms/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(p)});if(r.ok){alert('Update Sukses');closeEditRoomModal();loadRuangan()}else alert('Gagal')}catch(x){alert(x.message)}})
        let activeLoans=[];
        async function loadPeralatan(){try{const r1=await fetch(`${API_URL}/equipment`,{headers:{'Authorization':`Bearer ${token}`}});const d1=await r1.json();const r2=await fetch(`${API_URL}/booking/active-tools`,{headers:{'Authorization':`Bearer ${token}`}});activeLoans=await r2.json();const tb=document.getElementById('table-peralatan-body');tb.innerHTML='';d1.forEach(i=>{const l=activeLoans.filter(x=>x.alat_id===i.id);const tb=l.reduce((s,x)=>s+x.jumlah_pinjam,0);const s=i.jumlah_total-tb;const sc=s===0?'text-red-600 font-bold':(s<5?'text-orange-500 font-bold':'text-green-600');const bp=tb>0?`<button onclick="showBorrowers('${i.id}','${i.nama_alat}')" class="text-blue-600 hover:underline font-bold">${tb}</button>`:`<span class="text-gray-400">0</span>`;const be=`<button onclick="openEditToolModal('${i.id}','${i.nama_alat}','${i.kategori}','${i.jumlah_total}','${i.kondisi}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs border border-blue-200 px-2 py-1 rounded mr-2">Edit</button>`;tb.innerHTML+=`<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6"><div class="font-bold text-gray-800">${i.nama_alat}</div><div class="text-xs text-gray-500">${i.kategori}</div></td><td class="py-3 px-6 text-center">${i.jumlah_total}</td><td class="py-3 px-6 text-center text-lg">${bp}</td><td class="py-3 px-6 text-center ${sc}">${s}</td><td class="py-3 px-6 text-center flex justify-center items-center pt-4">${be}<button onclick="deleteItem('equipment','${i.id}','Hapus?',loadPeralatan)" class="text-red-500 hover:text-red-700 text-lg">&times;</button></td></tr>`})}catch(e){console.error(e)}}
        function showBorrowers(id,n){document.getElementById('modalToolName').innerText=`Peminjam: ${n}`;const l=document.getElementById('borrowerList');l.innerHTML='';const ls=activeLoans.filter(x=>x.alat_id===id);ls.forEach(x=>{l.innerHTML+=`<div class="bg-gray-50 p-3 rounded border border-gray-200 flex justify-between items-center mb-2"><div><div class="font-bold text-gray-800">${x.peminjaman.users?.nama||'Unk'}</div><div class="text-xs text-gray-500">üìÖ ${new Date(x.peminjaman.waktu_mulai).toLocaleDateString()}</div></div><div class="font-bold text-xl text-blue-800 bg-blue-100 px-3 py-1 rounded">${x.jumlah_pinjam}</div></div>`});document.getElementById('borrowerModal').classList.remove('hidden')}
        function closeBorrowerModal(){document.getElementById('borrowerModal').classList.add('hidden')}
        async function handleTambahPeralatan(e){e.preventDefault();await fetch(`${API_URL}/equipment`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({nama_alat:document.getElementById('nama_alat').value,kategori:document.getElementById('kategori').value,jumlah_total:document.getElementById('jumlah_total').value,kondisi:document.getElementById('kondisi').value})});e.target.reset();loadPeralatan()}
        function openEditToolModal(id,n,k,t,c){document.getElementById('edit_alat_id').value=id;document.getElementById('edit_nama_alat').value=n;document.getElementById('edit_kategori').value=k;document.getElementById('edit_jumlah_total').value=t;document.getElementById('edit_kondisi').value=c;document.getElementById('editToolModal').classList.remove('hidden')}
        function closeEditToolModal(){document.getElementById('editToolModal').classList.add('hidden')}
        document.getElementById('form-edit-alat').addEventListener('submit',async(e)=>{e.preventDefault();const id=document.getElementById('edit_alat_id').value;const p={nama_alat:document.getElementById('edit_nama_alat').value,kategori:document.getElementById('edit_kategori').value,jumlah_total:document.getElementById('edit_jumlah_total').value,kondisi:document.getElementById('edit_kondisi').value};try{const r=await fetch(`${API_URL}/equipment/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(p)});if(r.ok){alert('Sukses');closeEditToolModal();loadPeralatan()}else alert('Gagal')}catch(x){alert(x.message)}})
        async function loadReports(){const r=await fetch(`${API_URL}/reports/all`,{headers:{'Authorization':`Bearer ${token}`}});const d=await r.json();const b=document.getElementById('table-reports-body');b.innerHTML='';if(d.length===0)b.innerHTML='<tr><td colspan="5" class="text-center py-4">Kosong</td></tr>';else d.forEach(i=>{b.innerHTML+=`<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6 text-xs">${new Date(i.tanggal_lapor).toLocaleDateString()}</td><td class="py-3 px-6 font-bold">${i.users?.nama||'User'}</td><td class="py-3 px-6 text-blue-600">${i.peralatan?.nama_alat||'-'}</td><td class="py-3 px-6 text-xs truncate max-w-xs" title="${i.deskripsi_kerusakan}">${i.deskripsi_kerusakan}</td><td class="py-3 px-6 text-center"><select onchange="updateReportStatus('${i.id}',this.value)" class="border rounded text-xs"><option value="baru" ${i.status_laporan==='baru'?'selected':''}>Baru</option><option value="diproses" ${i.status_laporan==='diproses'?'selected':''}>Diproses</option><option value="selesai" ${i.status_laporan==='selesai'?'selected':''}>Selesai</option></select></td></tr>`})}
        async function updateReportStatus(id,s){if(confirm('Update?'))await fetch(`${API_URL}/reports/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status_laporan:s})});loadReports()}
        function toggleModal(){document.getElementById('scheduleModal').classList.toggle('hidden')}
        async function showRoomSchedule(roomId,n){document.getElementById('modalRoomName').innerText=`Jadwal: ${n}`;const l=document.getElementById('modalScheduleList');const e=document.getElementById('modalEmpty');l.innerHTML='<li class="text-center">Loading...</li>';e.classList.add('hidden');toggleModal();const r=await fetch(`${API_URL}/booking/schedule`,{headers:{'Authorization':`Bearer ${token}`}});const s=await r.json();const rs=s.filter(x=>x.ruang_id===roomId).sort((a,b)=>new Date(a.waktu_mulai)-new Date(b.waktu_mulai));l.innerHTML='';if(rs.length===0)e.classList.remove('hidden');else rs.forEach(x=>{l.innerHTML+=`<li class="bg-blue-50 p-2 rounded border-l-4 border-blue-500 text-gray-700"><span class="font-bold block">${new Date(x.waktu_mulai).toLocaleString()}</span> s/d ${new Date(x.waktu_selesai).toLocaleTimeString()}</li>`})}
        function logout(){localStorage.clear();window.location.href='index.html'}
        document.addEventListener('DOMContentLoaded',()=>{showTab('dashboard');loadAnalytics();loadAllBookings();loadRuangan();loadPeralatan();loadReports();loadRuangOptions();document.getElementById('form-tambah-jadwal').addEventListener('submit',handleTambahJadwal);document.getElementById('form-tambah-ruang').addEventListener('submit',handleTambahRuang);document.getElementById('form-tambah-peralatan').addEventListener('submit',handleTambahPeralatan)});
    </script>
</body>
</html>