<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SIL Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden-row { display: none; }
        .rotate-90 { transform: rotate(90deg); }
        .transition-transform { transition: transform 0.3s ease; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    <!-- NAVBAR -->
    <nav class="bg-gray-900 p-4 text-white flex justify-between items-center shadow-lg sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-xl tracking-wide">ADMIN PANEL SIL</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <span id="adminName" class="block font-bold text-sm text-yellow-400">Admin</span>
                <span class="block text-xs text-gray-400">Administrator Mode</span>
            </div>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition font-medium shadow">Keluar</button>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        
        <!-- Navigasi Tab -->
        <div class="mb-6 bg-white rounded-lg shadow-sm p-1 flex flex-wrap gap-1">
            <button onclick="showTab('peminjaman')" id="tab-peminjaman" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center bg-blue-600 text-white transition">
                üìÖ Jadwal & Peminjaman
            </button>
            <button onclick="showTab('ruangan')" id="tab-ruangan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üè¢ Ruangan
            </button>
            <button onclick="showTab('peralatan')" id="tab-peralatan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üì¶ Stok & Peminjam Alat
            </button>
            <button onclick="showTab('laporan')" id="tab-laporan" class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üõ†Ô∏è Kerusakan
            </button>
        </div>

        <!-- TAB 1, 2, 4 (SAMA SEPERTI SEBELUMNYA - DIHEMAT AGAR TIDAK KEPANJANGAN) -->
        <div id="content-peminjaman" class="tab-content active">
            <!-- (Isi Tab Peminjaman Sama Spt Sebelumnya) -->
            <!-- Saya sertakan placeholder, nanti script JS yang akan mengisi isinya jika Anda copy-paste full dari file sebelumnya. 
                 NAMUN, agar file ini BISA LANGSUNG DIGUNAKAN, saya akan copy ulang bagian layout dasarnya. -->
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- KIRI -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200 sticky top-24">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Jadwal Manual</h3>
                    <form id="form-tambah-jadwal" class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ruangan</label><select id="jadwal_ruang_id" class="w-full p-2 border rounded bg-gray-50" required><option value="">Memuat...</option></select></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai</label><input type="datetime-local" id="jadwal_mulai" class="w-full p-2 border rounded bg-gray-50 text-sm" required></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai</label><input type="datetime-local" id="jadwal_selesai" class="w-full p-2 border rounded bg-gray-50 text-sm" required></div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="flex items-center mb-2"><input type="checkbox" id="is_repeat" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" onchange="toggleRepeatInput()"><label for="is_repeat" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">Ulangi Jadwal (Mingguan)?</label></div><div id="repeat_input_container" class="hidden mt-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jumlah Minggu</label><input type="number" id="repeat_count" class="w-full p-2 border rounded bg-white text-sm" value="16" min="2" max="20"></div></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan</label><textarea id="jadwal_tujuan" class="w-full p-2 border rounded bg-gray-50 text-sm" rows="2" required></textarea></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium shadow transition">Simpan Jadwal</button>
                    </form>
                </div>
                <!-- KANAN -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-yellow-200"><div class="p-4 bg-yellow-50 border-b border-yellow-200 flex justify-between items-center"><h3 class="font-bold text-yellow-800">üîî Permintaan Masuk (Pending)</h3><button onclick="loadAllBookings()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh</button></div><div class="overflow-x-auto"><table class="min-w-full"><tbody id="pendingTableBody" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div>
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200"><div class="p-4 bg-gray-50 border-b border-gray-200"><h3 class="font-bold text-gray-700">üìÖ Jadwal Terkonfirmasi</h3></div><div class="overflow-x-auto"><table class="min-w-full"><tbody id="approvedTableBody" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div></div>
                </div>
            </div>
        </div>

        <div id="content-ruangan" class="tab-content">
            <!-- (Isi Ruangan Sama) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200"><h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Ruangan</h3><form id="form-tambah-ruang" class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama</label><input type="text" id="nama_ruang" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label><input type="number" id="kapasitas" class="w-full p-2 border rounded bg-gray-50" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label><input type="text" id="lokasi" class="w-full p-2 border rounded bg-gray-50" required></div><button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-medium shadow">Simpan</button></form></div>
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200"><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="py-3 px-6 text-left font-bold">Ruangan</th><th class="py-3 px-6 text-left font-bold">Status</th><th class="py-3 px-6 text-center font-bold">Aksi</th></tr></thead><tbody id="table-ruangan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody></table></div>
            </div>
        </div>

        <div id="content-laporan" class="tab-content">
            <!-- (Isi Laporan Sama) -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200"><div class="p-5 border-b bg-gray-50 flex justify-between items-center"><div><h3 class="text-lg font-bold text-red-800">Daftar Laporan</h3></div><button onclick="loadReports()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh</button></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="py-3 px-6 text-left font-bold">Info</th><th class="py-3 px-6 text-left font-bold">Alat & Masalah</th><th class="py-3 px-6 text-center font-bold">Status</th></tr></thead><tbody id="table-reports-body" class="text-gray-700 text-sm divide-y divide-gray-100"></tbody></table></div></div>
        </div>

        <!-- === TAB 3: PERALATAN (DIPERBARUI TOTAL) === -->
        <div id="content-peralatan" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Form Tambah Alat -->
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Alat</h3>
                    <form id="form-tambah-peralatan" class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Alat</label><input type="text" id="nama_alat" class="w-full p-2 border rounded bg-gray-50" required></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label><input type="text" id="kategori" class="w-full p-2 border rounded bg-gray-50" required></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Stok</label><input type="number" id="jumlah_total" class="w-full p-2 border rounded bg-gray-50" required></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label><select id="kondisi" class="w-full p-2 border rounded bg-gray-50"><option value="baik">Baik</option><option value="rusak">Rusak</option><option value="maintenance">Maintenance</option></select></div>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 font-medium shadow">Simpan Alat</button>
                    </form>
                </div>
                
                <!-- Tabel Monitoring Stok -->
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">üì¶ Monitoring Stok Alat</h3>
                        <button onclick="loadPeralatan()" class="text-blue-600 text-sm hover:underline">üîÑ Refresh Stok</button>
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Nama Alat</th>
                                <th class="py-3 px-6 text-center font-bold">Total</th>
                                <th class="py-3 px-6 text-center font-bold">Dipinjam</th>
                                <th class="py-3 px-6 text-center font-bold">Sisa</th>
                                <th class="py-3 px-6 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-peralatan-body" class="text-gray-600 text-sm divide-y divide-gray-100">
                            <!-- Data Stok -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DAFTAR PEMINJAM ALAT -->
    <div id="borrowerModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeBorrowerModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto p-6">
            <div class="flex justify-between mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="modalToolName">Detail Peminjam</h3>
                <button onclick="closeBorrowerModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button>
            </div>
            <div id="borrowerList" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <!-- MODAL JADWAL (Sama seperti sebelumnya) -->
    <div id="scheduleModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[80vh] p-6">
            <div class="flex justify-between mb-4 border-b pb-2"><h3 class="text-lg font-bold text-gray-800" id="modalRoomName">Jadwal</h3><button onclick="toggleModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button></div>
            <ul id="modalScheduleList" class="space-y-2 text-sm"></ul>
            <p id="modalEmpty" class="text-center text-gray-400 text-sm hidden">Tidak ada jadwal aktif.</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://sil-lab-backend.vercel.app/api'; 
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') { alert('Akses Ditolak!'); window.location.href = 'index.html'; }
        document.getElementById('adminName').innerText = user.nama || user.email || 'Admin';

        // --- NAVIGASI ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('bg-blue-600', 'text-white'); b.classList.add('text-gray-600', 'hover:bg-gray-100'); });
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:bg-gray-100');
        }

        async function deleteItem(endpoint, id, confirmMsg, refreshFn) {
            if(!confirm(confirmMsg)) return;
            try {
                const res = await fetch(`${API_URL}/${endpoint}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) { alert('Berhasil dihapus!'); refreshFn(); } else { alert('Gagal menghapus.'); }
            } catch(e) { alert(e.message); }
        }

        // --- PERALATAN: STOK & PEMINJAM (LOGIKA BARU) ---
        let activeLoans = []; // Menyimpan data peminjam aktif

        async function loadPeralatan() {
            try {
                // 1. Ambil Data Alat
                const resAlat = await fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } });
                const dataAlat = await resAlat.json();

                // 2. Ambil Data Peminjaman Aktif
                const resLoans = await fetch(`${API_URL}/booking/active-tools`, { headers: { 'Authorization': `Bearer ${token}` } });
                activeLoans = await resLoans.json();

                const tbody = document.getElementById('table-peralatan-body');
                tbody.innerHTML = '';

                dataAlat.forEach(item => {
                    // Hitung berapa yang sedang dipinjam
                    // Filter activeLoans berdasarkan alat_id
                    const loansForItem = activeLoans.filter(loan => loan.alat_id === item.id);
                    
                    // Sum jumlah_pinjam
                    const totalBorrowed = loansForItem.reduce((sum, loan) => sum + loan.jumlah_pinjam, 0);
                    const sisa = item.jumlah_total - totalBorrowed;

                    // Style untuk stok
                    const sisaColor = sisa === 0 ? 'text-red-600 font-bold' : (sisa < 5 ? 'text-orange-500 font-bold' : 'text-green-600');
                    
                    // Tombol lihat peminjam (hanya muncul jika ada yang pinjam)
                    const btnPeminjam = totalBorrowed > 0 
                        ? `<button onclick="showBorrowers('${item.id}', '${item.nama_alat}')" class="text-blue-600 hover:underline font-bold">${totalBorrowed}</button>`
                        : `<span class="text-gray-400">0</span>`;

                    const row = `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="py-3 px-6">
                                <div class="font-bold text-gray-800">${item.nama_alat}</div>
                                <div class="text-xs text-gray-500">${item.kategori} ‚Ä¢ ${item.kondisi}</div>
                            </td>
                            <td class="py-3 px-6 text-center">${item.jumlah_total}</td>
                            <td class="py-3 px-6 text-center text-lg">${btnPeminjam}</td>
                            <td class="py-3 px-6 text-center ${sisaColor}">${sisa}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="deleteItem('equipment', '${item.id}', 'Hapus alat?', loadPeralatan)" class="text-red-500 hover:text-red-700 text-lg" title="Hapus">&times;</button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) { console.error('Gagal load peralatan:', e); }
        }

        function showBorrowers(alatId, alatName) {
            document.getElementById('modalToolName').innerText = `Peminjam: ${alatName}`;
            const list = document.getElementById('borrowerList');
            list.innerHTML = '';

            const loans = activeLoans.filter(loan => loan.alat_id === alatId);
            
            loans.forEach(l => {
                const p = l.peminjaman; // Data user ada di dalam object peminjaman
                const user = p.users?.nama || 'Unknown';
                const email = p.users?.email || '';
                const start = new Date(p.waktu_mulai).toLocaleDateString();
                const end = new Date(p.waktu_selesai).toLocaleDateString();

                list.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-800">${user}</div>
                            <div class="text-xs text-gray-500">${email}</div>
                            <div class="text-xs text-blue-600 mt-1">üìÖ ${start} - ${end}</div>
                        </div>
                        <div class="font-bold text-xl text-blue-800 bg-blue-100 px-3 py-1 rounded">${l.jumlah_pinjam}</div>
                    </div>
                `;
            });

            document.getElementById('borrowerModal').classList.remove('hidden');
        }

        function closeBorrowerModal() { document.getElementById('borrowerModal').classList.add('hidden'); }

        async function handleTambahPeralatan(e) {
            e.preventDefault();
            const payload = {
                nama_alat: document.getElementById('nama_alat').value,
                kategori: document.getElementById('kategori').value,
                jumlah_total: document.getElementById('jumlah_total').value,
                kondisi: document.getElementById('kondisi').value
            };
            try {
                await fetch(`${API_URL}/equipment`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                alert('Sukses!'); e.target.reset(); loadPeralatan();
            } catch(e) { alert('Gagal'); }
        }

        // --- JADWAL, RUANGAN, LAPORAN (KODE LAMA TETAP SAMA) ---
        // (Saya persingkat agar muat, tapi fungsionalitas tetap sama seperti file sebelumnya)
        
        function toggleRepeatInput() { const isChecked = document.getElementById('is_repeat').checked; document.getElementById('repeat_input_container').className = isChecked ? 'mt-2' : 'hidden mt-2'; }
        async function loadRuangOptions() { const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); const s = document.getElementById('jadwal_ruang_id'); s.innerHTML = '<option value="">-- Pilih Ruangan --</option>'; data.forEach(r => { if(r.status!=='maintenance') s.innerHTML+=`<option value="${r.id}">${r.nama_ruang}</option>`}); }
        
        async function loadAllBookings() {
            const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json();
            const pendingBody = document.getElementById('pendingTableBody'); const approvedBody = document.getElementById('approvedTableBody');
            pendingBody.innerHTML = ''; approvedBody.innerHTML = '';
            const pendingData = data.filter(i => i.status === 'pending'); const approvedData = data.filter(i => i.status !== 'pending');

            if(pendingData.length===0) pendingBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center italic text-gray-400">Tidak ada permintaan baru</td></tr>';
            pendingData.forEach(item => {
                let info = `<div class="font-bold text-blue-600">${item.ruangan?.nama_ruang||'üì¶ Alat Saja'}</div>`;
                if(item.peminjaman_detail_alat && item.peminjaman_detail_alat.length>0) {
                    info += `<div class="text-xs text-gray-500 mt-1">Alat: ${item.peminjaman_detail_alat.map(t=>t.jumlah_pinjam+'x '+t.peralatan?.nama_alat).join(', ')}</div>`;
                }
                pendingBody.innerHTML += `<tr class="bg-yellow-50 border-b border-yellow-100"><td class="p-3"><div class="font-bold text-gray-800">${item.users?.nama||'User'}</div><div class="text-xs text-gray-500">${item.tujuan_peminjaman}</div></td><td class="p-3 text-xs">${info}<div>${new Date(item.waktu_mulai).toLocaleString()}</div></td><td class="p-3 text-center space-x-1"><button onclick="updateStatus('${item.id}', 'disetujui')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì</button><button onclick="updateStatus('${item.id}', 'ditolak')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">‚úï</button></td></tr>`;
            });

            const groups = {}; approvedData.forEach(item => { const base = item.tujuan_peminjaman.split(' (Pertemuan')[0]; const key = base + '_' + (item.ruang_id||'tool'); if(!groups[key]) groups[key] = []; groups[key].push(item); });
            for (const key in groups) {
                const items = groups[key]; items.sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));
                const first = items[0]; const baseName = first.tujuan_peminjaman.split(' (Pertemuan')[0]; const groupId = 'group-' + Math.random().toString(36).substr(2, 9);
                const roomName = first.ruangan ? first.ruangan.nama_ruang : 'üì¶ Peminjaman Alat';
                
                approvedBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50 transition cursor-pointer" onclick="toggleGroup('${groupId}')"><td class="p-3 text-center text-gray-400 font-bold text-lg transition-transform transform" id="icon-${groupId}">‚ñ∂</td><td class="p-3 font-bold text-gray-800">${baseName}<span class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full">${items.length} Sesi</span></td><td class="p-3 text-sm text-gray-600">${roomName}</td><td class="p-3 text-xs text-gray-500">Mulai: ${new Date(items[0].waktu_mulai).toLocaleDateString()}</td><td class="p-3 text-center"><button onclick="event.stopPropagation(); deleteBatch('${baseName}', '${first.ruang_id||'null'}')" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded bg-red-50">Hapus Semua</button></td></tr>`;
                let childRows = `<tr id="${groupId}" class="hidden-row bg-gray-50 shadow-inner"><td colspan="5" class="p-0"><table class="w-full">`;
                items.forEach(sub => { 
                    let toolInfo = ''; if(sub.peminjaman_detail_alat && sub.peminjaman_detail_alat.length>0) toolInfo = `<br><span class="text-gray-400 italic">Alat: ${sub.peminjaman_detail_alat.map(t=>t.jumlah_pinjam+'x '+t.peralatan?.nama_alat).join(', ')}</span>`;
                    childRows += `<tr class="border-b border-gray-200 text-xs text-gray-600 hover:bg-gray-100"><td class="p-3 pl-12 w-1/3 font-medium">${sub.tujuan_peminjaman} ${toolInfo}</td><td class="p-3">${new Date(sub.waktu_mulai).toLocaleString()}</td><td class="p-3 text-center w-24"><button onclick="deleteItem('booking', '${sub.id}', 'Hapus?', loadAllBookings)" class="text-red-400 hover:text-red-600 underline">Hapus</button></td></tr>`; 
                });
                approvedBody.innerHTML += childRows + `</table></td></tr>`;
            }
        }
        function toggleGroup(id) { const row = document.getElementById(id); const icon = document.getElementById('icon-'+id); if(row.classList.contains('hidden-row')) { row.classList.remove('hidden-row'); icon.style.transform='rotate(90deg)'; } else { row.classList.add('hidden-row'); icon.style.transform='rotate(0deg)'; } }
        async function deleteBatch(c, r) { if(!confirm('Hapus SEMUA?')) return; const res = await fetch(`${API_URL}/booking`, {headers:{'Authorization':`Bearer ${token}`}}); const d = await res.json(); const toDel = d.filter(i => i.tujuan_peminjaman.split(' (Pertemuan')[0] === c && (i.ruang_id||'null') === r && i.status !== 'pending'); for(const i of toDel) await fetch(`${API_URL}/booking/${i.id}`, {method:'DELETE', headers:{'Authorization':`Bearer ${token}`}}); loadAllBookings(); }
        
        async function handleTambahJadwal(e) { e.preventDefault(); const payload={ruang_id:document.getElementById('jadwal_ruang_id').value, waktu_mulai:new Date(document.getElementById('jadwal_mulai').value).toISOString(), waktu_selesai:new Date(document.getElementById('jadwal_selesai').value).toISOString(), tujuan_peminjaman:document.getElementById('jadwal_tujuan').value, is_repeat:document.getElementById('is_repeat').checked, repeat_count:document.getElementById('is_repeat').checked?parseInt(document.getElementById('repeat_count').value):1}; const res=await fetch(`${API_URL}/booking/admin`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(payload)}); if(res.ok){alert('Sukses');e.target.reset();loadAllBookings();}else{alert('Gagal');} }
        async function updateStatus(id, status) { await fetch(`${API_URL}/booking/${id}/status`, {method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status})}); loadAllBookings(); }

        async function loadRuangan() { const res=await fetch(`${API_URL}/rooms`,{headers:{'Authorization':`Bearer ${token}`}}); const data=await res.json(); document.getElementById('table-ruangan-body').innerHTML = data.map(i=>`<tr class="border-b hover:bg-gray-50"><td class="py-3 px-6 font-bold text-gray-800">${i.nama_ruang}</td><td class="py-3 px-6">${i.status==='maintenance'?'<span class="bg-orange-100 text-orange-800 px-2 rounded text-xs">MTC</span>':'<span class="bg-green-100 text-green-800 px-2 rounded text-xs">OK</span>'}</td><td class="py-3 px-6 text-center"><button onclick="showRoomSchedule('${i.id}','${i.nama_ruang}')" class="text-blue-600 underline text-xs mr-2">Jadwal</button><button onclick="setMaintenance('${i.id}', '${i.status==='maintenance'?'tersedia':'maintenance'}')" class="text-orange-500 underline text-xs mr-2">Status</button><button onclick="deleteItem('rooms','${i.id}','Hapus?',loadRuangan)" class="text-red-500 text-lg">&times;</button></td></tr>`).join(''); }
        async function setMaintenance(id,s){if(confirm('Ubah status?'))await fetch(`${API_URL}/rooms/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status:s})});loadRuangan(); loadRuangOptions();}
        async function handleTambahRuang(e){e.preventDefault(); await fetch(`${API_URL}/rooms`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({nama_ruang:document.getElementById('nama_ruang').value,kapasitas:document.getElementById('kapasitas').value,lokasi:document.getElementById('lokasi').value})}); e.target.reset(); loadRuangan(); loadRuangOptions();}

        async function loadReports() { const res=await fetch(`${API_URL}/reports/all`,{headers:{'Authorization':`Bearer ${token}`}}); const data=await res.json(); const b=document.getElementById('table-reports-body'); b.innerHTML=''; if(data.length===0) b.innerHTML='<tr><td colspan="5" class="text-center py-4">Tidak ada laporan.</td></tr>'; else data.forEach(i=>{ b.innerHTML+=`<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6 text-xs">${new Date(i.tanggal_lapor).toLocaleDateString()}</td><td class="py-3 px-6 font-bold">${i.users?.nama||'User'}</td><td class="py-3 px-6 text-blue-600">${i.peralatan?.nama_alat||'-'}</td><td class="py-3 px-6 text-xs truncate max-w-xs" title="${i.deskripsi_kerusakan}">${i.deskripsi_kerusakan}</td><td class="py-3 px-6 text-center"><select onchange="updateReportStatus('${i.id}',this.value)" class="border rounded text-xs"><option value="baru" ${i.status_laporan==='baru'?'selected':''}>Baru</option><option value="diproses" ${i.status_laporan==='diproses'?'selected':''}>Diproses</option><option value="selesai" ${i.status_laporan==='selesai'?'selected':''}>Selesai</option></select></td></tr>`}); }
        async function updateReportStatus(id,s){if(confirm('Update status?'))await fetch(`${API_URL}/reports/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status_laporan:s})});loadReports();}

        function toggleModal() { document.getElementById('scheduleModal').classList.toggle('hidden'); }
        async function showRoomSchedule(roomId, roomName) {
            document.getElementById('modalRoomName').innerText = `Jadwal: ${roomName}`; const list = document.getElementById('modalScheduleList'); const empty = document.getElementById('modalEmpty'); list.innerHTML = '<li class="text-center">Loading...</li>'; empty.classList.add('hidden'); toggleModal();
            const res = await fetch(`${API_URL}/booking/schedule`, { headers: { 'Authorization': `Bearer ${token}` } }); const schedules = await res.json();
            const roomSched = schedules.filter(s => s.ruang_id === roomId).sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));
            list.innerHTML = ''; if(roomSched.length === 0) empty.classList.remove('hidden'); else roomSched.forEach(s => { list.innerHTML += `<li class="bg-blue-50 p-2 rounded border-l-4 border-blue-500 text-gray-700"><span class="font-bold block">${new Date(s.waktu_mulai).toLocaleString()}</span> s/d ${new Date(s.waktu_selesai).toLocaleTimeString()}</li>`; });
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        document.addEventListener('DOMContentLoaded', () => { loadAllBookings(); loadRuangan(); loadPeralatan(); loadReports(); loadRuangOptions(); 
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-ruang').addEventListener('submit', handleTambahRuang);
            document.getElementById('form-tambah-peralatan').addEventListener('submit', handleTambahPeralatan);
        });
    </script>
</body>
</html>