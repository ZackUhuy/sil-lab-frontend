<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SIL Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Transisi untuk Accordion */
        .group-detail { transition: all 0.3s ease-in-out; }
        .hidden-row { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    <nav class="bg-gray-900 p-4 text-white flex justify-between items-center shadow-lg sticky top-0 z-50">
        <h1 class="font-bold text-xl tracking-wide">ADMIN PANEL SIL</h1>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition font-medium shadow">Keluar</button>
    </nav>

    <div class="container mx-auto p-6">
        
        <!-- Navigasi Tab -->
        <div class="mb-6 bg-white rounded-lg shadow-sm p-1 flex space-x-1">
            <button onclick="showTab('peminjaman')" id="tab-peminjaman" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-bold text-center bg-blue-600 text-white transition">
                üìÖ Jadwal & Peminjaman
            </button>
            <button onclick="showTab('ruangan')" id="tab-ruangan" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üè¢ Manajemen Ruangan
            </button>
            <button onclick="showTab('peralatan')" id="tab-peralatan" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">
                üõ†Ô∏è Manajemen Peralatan
            </button>
        </div>

        <!-- === TAB 1: MANAJEMEN JADWAL & PEMINJAMAN === -->
        <div id="content-peminjaman" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- FORM TAMBAH JADWAL MANUAL (KIRI) -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200 sticky top-24">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Jadwal Manual</h3>
                    <form id="form-tambah-jadwal" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ruangan</label>
                            <select id="jadwal_ruang_id" class="w-full p-2 border rounded bg-gray-50" required>
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai (Sesi 1)</label>
                                <input type="datetime-local" id="jadwal_mulai" class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai (Sesi 1)</label>
                                <input type="datetime-local" id="jadwal_selesai" class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                            </div>
                        </div>

                        <!-- FITUR ULANGI MINGGUAN -->
                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="is_repeat" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" onchange="toggleRepeatInput()">
                                <label for="is_repeat" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">Ulangi Jadwal (Mingguan)?</label>
                            </div>
                            <div id="repeat_input_container" class="hidden mt-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jumlah Minggu</label>
                                <input type="number" id="repeat_count" class="w-full p-2 border rounded bg-white text-sm" value="16" min="2" max="20" placeholder="Contoh: 16">
                                <p class="text-xs text-gray-400 mt-1 italic">*Jadwal akan diduplikasi setiap 7 hari.</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan Kegiatan</label>
                            <textarea id="jadwal_tujuan" class="w-full p-2 border rounded bg-gray-50 text-sm" rows="2" placeholder="Contoh: Kuliah Algoritma A" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium shadow transition">Simpan Jadwal</button>
                    </form>
                </div>

                <!-- TABEL DAFTAR (KANAN) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- 1. TABEL REQUEST PENDING (PRIORITAS) -->
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-yellow-200">
                        <div class="p-4 bg-yellow-50 border-b border-yellow-200 flex justify-between items-center">
                            <h3 class="font-bold text-yellow-800 flex items-center gap-2">
                                üîî Permintaan Masuk (Pending)
                            </h3>
                            <button onclick="loadAllBookings()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                                    <tr>
                                        <th class="py-2 px-4 text-left">User</th>
                                        <th class="py-2 px-4 text-left">Info</th>
                                        <th class="py-2 px-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTableBody" class="text-gray-600 text-sm divide-y divide-gray-100">
                                    <!-- Data Pending -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 2. TABEL JADWAL AKTIF (GROUPED) -->
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="font-bold text-gray-700">üìÖ Jadwal Kelas & Kegiatan (Terkonfirmasi)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0">
                                    <tr>
                                        <th class="py-3 px-4 text-left w-10"></th> <!-- Toggle Icon -->
                                        <th class="py-3 px-4 text-left">Nama Kegiatan / Kelas</th>
                                        <th class="py-3 px-4 text-left">Ruangan</th>
                                        <th class="py-3 px-4 text-left">Jadwal</th>
                                        <th class="py-3 px-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedTableBody" class="text-gray-600 text-sm divide-y divide-gray-100">
                                    <!-- Data Grouped -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- === TAB 2: RUANGAN === -->
        <div id="content-ruangan" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Ruangan</h3>
                    <form id="form-tambah-ruang" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Ruang</label>
                            <input type="text" id="nama_ruang" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label>
                            <input type="number" id="kapasitas" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label>
                            <input type="text" id="lokasi" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-medium shadow">Simpan Ruangan</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Ruangan</th>
                                <th class="py-3 px-6 text-left font-bold">Status</th>
                                <th class="py-3 px-6 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-ruangan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- === TAB 3: PERALATAN === -->
        <div id="content-peralatan" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Alat</h3>
                    <form id="form-tambah-peralatan" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Alat</label>
                            <input type="text" id="nama_alat" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label>
                            <input type="text" id="kategori" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total</label>
                                <input type="number" id="jumlah_total" class="w-full p-2 border rounded bg-gray-50" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label>
                                <select id="kondisi" class="w-full p-2 border rounded bg-gray-50">
                                    <option value="baik">Baik</option>
                                    <option value="rusak">Rusak</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 font-medium shadow">Simpan Alat</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Nama Alat</th>
                                <th class="py-3 px-6 text-left font-bold">Kategori</th>
                                <th class="py-3 px-6 text-center font-bold">Total</th>
                                <th class="py-3 px-6 text-center font-bold">Kondisi</th>
                                <th class="py-3 px-6 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-peralatan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL JADWAL -->
    <div id="scheduleModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[80vh] p-6">
            <div class="flex justify-between mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="modalRoomName">Jadwal</h3>
                <button onclick="toggleModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button>
            </div>
            <ul id="modalScheduleList" class="space-y-2 text-sm"></ul>
            <p id="modalEmpty" class="text-center text-gray-400 text-sm hidden">Tidak ada jadwal aktif.</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://sil-lab-backend.vercel.app/api'; 
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            alert('Akses Ditolak! Anda bukan Admin.');
            window.location.href = 'index.html';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            document.getElementById(`content-${tabName}`).classList.add('active');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('bg-blue-600', 'text-white');
            activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
        }

        async function deleteItem(endpoint, id, confirmMsg, refreshFn) {
            if(!confirm(confirmMsg)) return;
            try {
                const res = await fetch(`${API_URL}/${endpoint}/${id}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) { alert('Berhasil dihapus!'); refreshFn(); } 
                else { alert('Gagal menghapus.'); }
            } catch(e) { alert(e.message); }
        }

        // --- FUNGSI BARU: HAPUS SATU KELAS (BATCH DELETE) ---
        async function deleteBatch(className, roomId) {
            if(!confirm(`‚ö†Ô∏è BAHAYA: Anda yakin ingin menghapus SEMUA jadwal untuk kelas "${className}"? \nTindakan ini akan menghapus pertemuan ke-1 sampai selesai.`)) return;
            
            // Kita ambil semua data dulu (cara cepat tanpa ubah backend)
            try {
                const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                
                // Filter yang namanya mirip (base name)
                const toDelete = data.filter(item => {
                    const baseName = item.tujuan_peminjaman.split(' (Pertemuan')[0];
                    return baseName === className && item.ruang_id === roomId && item.status === 'disetujui';
                });

                let count = 0;
                for (const item of toDelete) {
                    await fetch(`${API_URL}/booking/${item.id}`, {
                        method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                    });
                    count++;
                }
                
                alert(`Berhasil menghapus ${count} jadwal pertemuan.`);
                loadAllBookings();

            } catch (e) { alert('Gagal batch delete: ' + e.message); }
        }

        // --- LOAD BOOKINGS DENGAN GROUPING ---
        async function loadAllBookings() {
            const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            const pendingBody = document.getElementById('pendingTableBody');
            const approvedBody = document.getElementById('approvedTableBody');
            pendingBody.innerHTML = '';
            approvedBody.innerHTML = '';

            // 1. PISAHKAN DATA
            const pendingData = data.filter(i => i.status === 'pending');
            const approvedData = data.filter(i => i.status !== 'pending');

            // 2. RENDER PENDING (SEDERHANA)
            if(pendingData.length === 0) pendingBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center italic text-gray-400">Tidak ada permintaan baru</td></tr>';
            
            pendingData.forEach(item => {
                const row = `
                    <tr class="bg-yellow-50 border-b border-yellow-100">
                        <td class="p-3">
                            <div class="font-bold text-gray-800">${item.users?.nama || 'User'}</div>
                            <div class="text-xs text-gray-500">${item.tujuan_peminjaman}</div>
                        </td>
                        <td class="p-3 text-xs">
                            <div class="font-bold text-blue-600">${item.ruangan?.nama_ruang || '-'}</div>
                            <div>${new Date(item.waktu_mulai).toLocaleString()}</div>
                        </td>
                        <td class="p-3 text-center space-x-1">
                            <button onclick="updateStatus('${item.id}', 'disetujui')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚úì</button>
                            <button onclick="updateStatus('${item.id}', 'ditolak')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">‚úï</button>
                        </td>
                    </tr>`;
                pendingBody.innerHTML += row;
            });

            // 3. RENDER APPROVED (GROUPING LOGIC)
            // Kelompokkan berdasarkan "Nama Dasar" (Hilangkan text "Pertemuan X")
            const groups = {};
            
            approvedData.forEach(item => {
                // Regex untuk menghapus " (Pertemuan 1)" dst
                const baseName = item.tujuan_peminjaman.split(' (Pertemuan')[0]; 
                const key = baseName + '_' + item.ruang_id; // Group by Name + Room
                
                if(!groups[key]) groups[key] = [];
                groups[key].push(item);
            });

            // Render Groups
            for (const key in groups) {
                const items = groups[key];
                const first = items[0];
                const baseName = first.tujuan_peminjaman.split(' (Pertemuan')[0];
                const count = items.length;
                
                // Sort tanggal
                items.sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));
                const startDate = new Date(items[0].waktu_mulai).toLocaleDateString('id-ID');

                // ID unik untuk accordion
                const groupId = 'group-' + Math.random().toString(36).substr(2, 9);

                // Header Baris (Parent)
                const parentRow = `
                    <tr class="bg-white border-b hover:bg-gray-50 transition cursor-pointer" onclick="toggleGroup('${groupId}')">
                        <td class="p-3 text-center text-gray-400 font-bold text-lg transition-transform transform" id="icon-${groupId}">‚ñ∂</td>
                        <td class="p-3 font-bold text-gray-800">
                            ${baseName}
                            <span class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full">${count} Pertemuan</span>
                        </td>
                        <td class="p-3 text-sm text-gray-600">${first.ruangan?.nama_ruang || '-'}</td>
                        <td class="p-3 text-xs text-gray-500">Mulai: ${startDate}</td>
                        <td class="p-3 text-center">
                            <button onclick="event.stopPropagation(); deleteBatch('${baseName}', '${first.ruang_id}')" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded bg-red-50">Hapus Semua</button>
                        </td>
                    </tr>
                `;
                approvedBody.innerHTML += parentRow;

                // Child Rows (Hidden)
                let childRows = `<tr id="${groupId}" class="hidden-row bg-gray-50 shadow-inner"><td colspan="5" class="p-0"><table class="w-full">`;
                items.forEach(sub => {
                    const date = new Date(sub.waktu_mulai).toLocaleString();
                    childRows += `
                        <tr class="border-b border-gray-200 text-xs text-gray-600">
                            <td class="p-3 pl-10 w-1/3">${sub.tujuan_peminjaman}</td>
                            <td class="p-3">${date}</td>
                            <td class="p-3 text-center w-20">
                                <button onclick="deleteItem('booking', '${sub.id}', 'Hapus pertemuan ini saja?', loadAllBookings)" class="text-red-400 hover:text-red-600">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
                childRows += `</table></td></tr>`;
                approvedBody.innerHTML += childRows;
            }
        }

        function toggleGroup(id) {
            const row = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (row.classList.contains('hidden-row')) {
                row.classList.remove('hidden-row');
                icon.style.transform = 'rotate(90deg)';
            } else {
                row.classList.add('hidden-row');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // ... (Fungsi Handle Tambah Jadwal, Status, Ruangan, Alat TETAP SAMA seperti sebelumnya) ...
        // ... COPY-PASTE SISA SCRIPT DARI FILE LAMA ANDA DI BAWAH INI ...
        // (Saya tulis ulang inti fungsi penting agar file ini utuh)

        function toggleRepeatInput() {
            const isChecked = document.getElementById('is_repeat').checked;
            const container = document.getElementById('repeat_input_container');
            if (isChecked) container.classList.remove('hidden'); else container.classList.add('hidden');
        }

        async function loadRuangOptions() {
            const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const select = document.getElementById('jadwal_ruang_id');
            select.innerHTML = '<option value="">-- Pilih Ruangan --</option>';
            data.forEach(r => {
                if (r.status !== 'maintenance') select.innerHTML += `<option value="${r.id}">${r.nama_ruang}</option>`;
            });
        }

        async function handleTambahJadwal(e) {
            e.preventDefault();
            const isRepeat = document.getElementById('is_repeat').checked;
            const repeatCount = document.getElementById('repeat_count').value;
            const payload = {
                ruang_id: document.getElementById('jadwal_ruang_id').value,
                waktu_mulai: new Date(document.getElementById('jadwal_mulai').value).toISOString(),
                waktu_selesai: new Date(document.getElementById('jadwal_selesai').value).toISOString(),
                tujuan_peminjaman: document.getElementById('jadwal_tujuan').value,
                is_repeat: isRepeat,
                repeat_count: isRepeat ? parseInt(repeatCount) : 1
            };
            const btn = e.target.querySelector('button'); const oldText = btn.innerText; btn.innerText = 'Memproses...'; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/booking/admin`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                const r = await res.json();
                if(!res.ok) throw new Error(r.error);
                alert(r.message); e.target.reset(); document.getElementById('repeat_input_container').classList.add('hidden'); loadAllBookings();
            } catch(err) { alert('Gagal: ' + err.message); } finally { btn.innerText = oldText; btn.disabled = false; }
        }

        async function updateStatus(id, status) {
            await fetch(`${API_URL}/booking/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status }) });
            loadAllBookings();
        }

        // --- RUANGAN & PERALATAN (Standard) ---
        async function loadRuangan() {
            const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const tbody = document.getElementById('table-ruangan-body'); tbody.innerHTML = '';
            data.forEach(item => {
                const isMtc = item.status === 'maintenance';
                const statusBadge = isMtc ? `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold border border-orange-200">üõ†Ô∏è MAINTENANCE</span>` : `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-200">‚úÖ TERSEDIA</span>`;
                const btnMtc = isMtc ? `<button onclick="setMaintenance('${item.id}', 'tersedia')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 shadow">Aktifkan</button>` : `<button onclick="setMaintenance('${item.id}', 'maintenance')" class="bg-orange-400 text-white px-2 py-1 rounded text-xs hover:bg-orange-500 shadow">Maintenance</button>`;
                const row = `<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6"><div class="font-bold text-gray-800">${item.nama_ruang}</div><div class="text-xs text-gray-500">${item.lokasi} ‚Ä¢ Kap: ${item.kapasitas}</div></td><td class="py-3 px-6">${statusBadge}</td><td class="py-3 px-6 text-center space-x-2 flex justify-center items-center mt-2"><button onclick="showRoomSchedule('${item.id}', '${item.nama_ruang}')" class="text-blue-600 hover:text-blue-800 text-xs font-medium underline">Jadwal</button>${btnMtc}<button onclick="deleteItem('rooms', '${item.id}', 'Hapus ruangan ${item.nama_ruang}?', loadRuangan)" class="text-red-500 hover:text-red-700 text-lg" title="Hapus">&times;</button></td></tr>`;
                tbody.innerHTML += row;
            });
        }
        async function setMaintenance(id, newStatus) {
            if(!confirm('Ubah status?')) return;
            await fetch(`${API_URL}/rooms/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status: newStatus }) });
            loadRuangan(); loadRuangOptions();
        }
        async function handleTambahRuang(e) {
            e.preventDefault();
            const payload = { nama_ruang: document.getElementById('nama_ruang').value, kapasitas: document.getElementById('kapasitas').value, lokasi: document.getElementById('lokasi').value };
            await fetch(`${API_URL}/rooms`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
            alert('Sukses!'); e.target.reset(); loadRuangan(); loadRuangOptions();
        }
        async function loadPeralatan() {
            const res = await fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const tbody = document.getElementById('table-peralatan-body'); tbody.innerHTML = '';
            data.forEach(item => {
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6 font-medium">${item.nama_alat}</td><td class="py-3 px-6 text-gray-500">${item.kategori}</td><td class="py-3 px-6 text-center font-bold">${item.jumlah_total}</td><td class="py-3 px-6 text-center"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${item.kondisi}</span></td><td class="py-3 px-6 text-center"><button onclick="deleteItem('equipment', '${item.id}', 'Hapus alat ${item.nama_alat}?', loadPeralatan)" class="text-red-500 hover:text-red-700 text-xs font-bold">Hapus</button></td></tr>`;
            });
        }
        async function handleTambahPeralatan(e) {
            e.preventDefault();
            const payload = { nama_alat: document.getElementById('nama_alat').value, kategori: document.getElementById('kategori').value, jumlah_total: document.getElementById('jumlah_total').value, kondisi: document.getElementById('kondisi').value };
            await fetch(`${API_URL}/equipment`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
            alert('Sukses!'); e.target.reset(); loadPeralatan();
        }

        function toggleModal() { document.getElementById('scheduleModal').classList.toggle('hidden'); }
        async function showRoomSchedule(roomId, roomName) {
            document.getElementById('modalRoomName').innerText = `Jadwal: ${roomName}`;
            const list = document.getElementById('modalScheduleList');
            const empty = document.getElementById('modalEmpty');
            list.innerHTML = '<li class="text-center text-gray-400">Loading...</li>'; empty.classList.add('hidden'); toggleModal();
            const res = await fetch(`${API_URL}/booking/schedule`, { headers: { 'Authorization': `Bearer ${token}` } });
            const schedules = await res.json();
            const roomSched = schedules.filter(s => s.ruang_id === roomId).sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));
            list.innerHTML = '';
            if(roomSched.length === 0) { empty.classList.remove('hidden'); } 
            else { roomSched.forEach(s => { list.innerHTML += `<li class="bg-blue-50 p-2 rounded border-l-4 border-blue-500 text-gray-700"><span class="font-bold block">${new Date(s.waktu_mulai).toLocaleString()}</span> s/d ${new Date(s.waktu_selesai).toLocaleTimeString()}</li>`; }); }
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }

        document.addEventListener('DOMContentLoaded', () => {
            loadAllBookings(); loadRuangan(); loadPeralatan(); loadRuangOptions();
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-ruang').addEventListener('submit', handleTambahRuang);
            document.getElementById('form-tambah-peralatan').addEventListener('submit', handleTambahPeralatan);
        });
    </script>
</body>
</html>