<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SISIL</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 'fade-in-up': 'fadeInUp 0.6s ease-out forwards' },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .hidden-row {
            display: none;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        .transition-transform {
            transition: transform 0.3s ease;
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        .sticky-date {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 font-sans min-h-screen">

    <nav
        class="bg-gray-900/95 backdrop-blur-md p-4 text-white flex justify-between items-center shadow-lg sticky top-0 z-50 border-b border-gray-800">
        <div class="flex items-center gap-3">
            <h1 class="font-bold text-xl tracking-wide"><i class="fas fa-server mr-2 text-blue-500"></i>ADMIN PANEL
                SISIL</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <span id="adminName" class="block font-bold text-sm text-yellow-400">Admin</span>
                <span class="block text-xs text-gray-400">Administrator Mode</span>
            </div>
            <button onclick="logout()"
                class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm transition font-medium shadow flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </div>
    </nav>

    <div class="container mx-auto p-6 pb-24">

        <div class="mb-8 bg-white rounded-2xl shadow-sm p-1.5 flex flex-wrap gap-2 border border-slate-200">
            <button onclick="showTab('dashboard')" id="tab-dashboard"
                class="tab-button flex-grow md:flex-1 py-3 px-4 rounded-xl text-sm font-bold text-center bg-blue-600 text-white transition-all shadow-md">üìä
                Dashboard</button>
            <button onclick="showTab('peminjaman')" id="tab-peminjaman"
                class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">üìÖ
                Jadwal & Approval</button>
            <button onclick="showTab('ruangan')" id="tab-ruangan"
                class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">üè¢
                Data Ruangan</button>
            <button onclick="showTab('peralatan')" id="tab-peralatan"
                class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">üì¶
                Data Alat & Bahan</button>
            <button onclick="showTab('laporan')" id="tab-laporan"
                class="tab-button flex-grow md:flex-1 py-3 px-2 rounded-md text-sm font-bold text-center text-gray-600 hover:bg-gray-100 transition">üõ†Ô∏è
                Laporan Kerusakan</button>
        </div>

        <div id="content-dashboard" class="tab-content active animate-fade-in-up">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
                    <div class="text-indigo-600 text-xs font-bold uppercase tracking-wider mb-1">Jadwal Kuliah (Admin)
                    </div>
                    <div class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-admin">-</div>
                </div>
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-green-500"></div>
                    <div class="text-green-600 text-xs font-bold uppercase tracking-wider mb-1">Peminjaman User (ACC)
                    </div>
                    <div class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-user">-</div>
                </div>
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-yellow-400"></div>
                    <div class="text-yellow-600 text-xs font-bold uppercase tracking-wider mb-1">Menunggu Persetujuan
                    </div>
                    <div class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-pending">-</div>
                </div>
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-red-500"></div>
                    <div class="text-red-600 text-xs font-bold uppercase tracking-wider mb-1">Laporan Kerusakan</div>
                    <div class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-damage">-</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-4 text-center">Komposisi Penggunaan</h3>
                    <div class="relative h-48 w-full flex justify-center items-center"><canvas id="typeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-100 lg:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">üè¢ Frekuensi Ruangan</h3>
                    <div class="relative h-64 w-full flex items-center justify-center bg-gray-50 rounded-lg"><canvas
                            id="roomChart"></canvas>
                        <p id="roomChartEmpty" class="hidden text-gray-400 text-sm italic">Belum ada data.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-100 lg:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">üì¶ 5 Alat Terpopuler</h3>
                    <div class="relative h-48 w-full flex items-center justify-center bg-gray-50 rounded-lg"><canvas
                            id="toolChart"></canvas>
                        <p id="toolChartEmpty" class="hidden text-gray-400 text-sm italic">Belum ada data.</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-3">Laporan & Export</h3>
                    <div class="space-y-3">
                        <button onclick="exportToCSV()"
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-xl hover:bg-green-700 text-sm font-bold flex justify-center items-center gap-2 shadow transition"><i
                                class="fas fa-file-csv"></i> Data Peminjaman (CSV)</button>
                        <button onclick="exportEquipmentCSV()"
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl hover:bg-blue-700 text-sm font-bold flex justify-center items-center gap-2 shadow transition"><i
                                class="fas fa-file-csv"></i> Data Inventaris (CSV)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-peminjaman" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200 sticky top-24">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Jadwal Manual</h3>
                    <form id="form-tambah-jadwal" class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ruangan <span
                                    class="text-red-500">*</span></label><select id="jadwal_ruang_id"
                                class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Memuat...</option>
                            </select></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai</label><input
                                    type="datetime-local" id="jadwal_mulai"
                                    class="w-full p-2 border rounded bg-gray-50 text-sm" required></div>
                            <div><label
                                    class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai</label><input
                                    type="datetime-local" id="jadwal_selesai"
                                    class="w-full p-2 border rounded bg-gray-50 text-sm" required></div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                            <div class="flex items-center mb-2"><input type="checkbox" id="is_repeat"
                                    class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
                                    onchange="toggleRepeatInput()"><label for="is_repeat"
                                    class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">Ulangi Jadwal
                                    (Mingguan)?</label></div>
                            <div id="repeat_input_container" class="hidden mt-2"><label
                                    class="block text-xs font-bold text-gray-500 uppercase mb-1">Jumlah
                                    Minggu</label><input type="number" id="repeat_count"
                                    class="w-full p-2 border rounded bg-white text-sm" value="16" min="2" max="20"
                                    placeholder="16"></div>
                        </div>
                        <div><label
                                class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan</label><textarea
                                id="jadwal_tujuan" class="w-full p-2 border rounded bg-gray-50 text-sm" rows="2"
                                placeholder="Contoh: Kuliah Algoritma A" required></textarea></div>
                        <button type="submit"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium shadow transition">Simpan
                            Jadwal</button>
                    </form>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-yellow-200">
                        <div class="p-4 bg-yellow-50 border-b border-yellow-200 flex justify-between items-center">
                            <h3 class="font-bold text-yellow-800 flex items-center gap-2">üîî Permintaan Masuk (Pending)
                            </h3><button onclick="loadAllBookings()"
                                class="text-blue-600 text-sm hover:underline font-medium">üîÑ Refresh</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                                    <tr>
                                        <th class="py-2 px-4 text-left">User</th>
                                        <th class="py-2 px-4 text-left">Info</th>
                                        <th class="py-2 px-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTableBody" class="text-gray-600 text-sm divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="font-bold text-gray-700">üìÖ Jadwal Terkonfirmasi</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0">
                                    <tr>
                                        <th class="py-3 px-4 w-10"></th>
                                        <th class="py-3 px-4 text-left">Kegiatan</th>
                                        <th class="py-3 px-4 text-left">Peminjam</th>
                                        <th class="py-3 px-4 text-left">Ruangan</th>
                                        <th class="py-3 px-4 text-left">Waktu</th>
                                        <th class="py-3 px-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedTableBody" class="text-gray-600 text-sm divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-ruangan" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Ruangan</h3>
                    <form id="form-tambah-ruang" class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama
                                Ruang</label><input type="text" id="nama_ruang"
                                class="w-full p-2 border rounded bg-gray-50" required></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label><input
                                type="number" id="kapasitas" class="w-full p-2 border rounded bg-gray-50" required>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label><input
                                type="text" id="lokasi" class="w-full p-2 border rounded bg-gray-50" required></div>
                        <button type="submit"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-medium shadow">Simpan
                            Ruangan</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Ruangan</th>
                                <th class="py-3 px-6 text-left font-bold">Status</th>
                                <th class="py-3 px-6 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-ruangan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-peralatan" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit border border-gray-200">
                    <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-3">Tambah Alat / Bahan</h3>
                    <form id="form-tambah-peralatan" class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama
                                Barang</label><input type="text" id="nama_alat"
                                class="w-full p-2 border rounded bg-gray-50" placeholder="Contoh: Mikroskop / Alkohol"
                                required></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenis Barang</label>
                            <select id="jenis_alat"
                                class="w-full p-2 border rounded bg-gray-50 font-semibold text-gray-700">
                                <option value="alat">üõ†Ô∏è Alat (Aset)</option>
                                <option value="bahan">üíß Bahan (Habis Pakai)</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label><input
                                type="text" id="kategori" class="w-full p-2 border rounded bg-gray-50" required></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total
                                    Stok</label><input type="number" id="jumlah_total"
                                    class="w-full p-2 border rounded bg-gray-50" required></div>
                            <div><label
                                    class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label><select
                                    id="kondisi" class="w-full p-2 border rounded bg-gray-50">
                                    <option value="baik">Baik</option>
                                    <option value="rusak">Rusak</option>
                                    <option value="maintenance">Maintenance</option>
                                </select></div>
                        </div>
                        <button type="submit"
                            class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 font-medium shadow">Simpan
                            Data</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">üì¶ Monitoring Stok</h3><button onclick="loadPeralatan()"
                            class="text-blue-600 text-sm hover:underline">üîÑ Refresh Stok</button>
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Nama Barang</th>
                                <th class="py-3 px-6 text-center font-bold">Jenis</th>
                                <th class="py-3 px-6 text-center font-bold">Total</th>
                                <th class="py-3 px-6 text-center font-bold">Dipinjam</th>
                                <th class="py-3 px-6 text-center font-bold">Sisa</th>
                                <th class="py-3 px-6 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-peralatan-body" class="text-gray-600 text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-laporan" class="tab-content">
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-red-800">Daftar Laporan Kerusakan</h3>
                        <p class="text-xs text-gray-500">Pantau dan update status perbaikan alat di sini.</p>
                    </div><button onclick="loadReports()" class="text-blue-600 text-sm hover:underline font-medium">üîÑ
                        Refresh Data</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left font-bold">Tanggal</th>
                                <th class="py-3 px-6 text-left font-bold">Pelapor</th>
                                <th class="py-3 px-6 text-left font-bold">Nama Alat</th>
                                <th class="py-3 px-6 text-left font-bold">Deskripsi Masalah</th>
                                <th class="py-3 px-6 text-center font-bold">Update Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-reports-body" class="text-gray-700 text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="borrowerModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeBorrowerModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto p-6">
            <div class="flex justify-between mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="modalToolName">Detail Peminjam</h3><button
                    onclick="closeBorrowerModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button>
            </div>
            <div id="borrowerList" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <div id="scheduleModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[80vh] p-6">
            <div class="flex justify-between mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="modalRoomName">Jadwal</h3><button
                    onclick="toggleModal()" class="text-gray-500 hover:text-red-500 font-bold">‚úï</button>
            </div>
            <ul id="modalScheduleList" class="space-y-2 text-sm"></ul>
            <p id="modalEmpty" class="text-center text-gray-400 text-sm hidden">Tidak ada jadwal aktif.</p>
        </div>
    </div>

    <div id="editRoomModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeEditRoomModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Edit Ruangan</h3>
            <form id="form-edit-ruangan"><input type="hidden" id="edit_room_id">
                <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama
                        Ruang</label><input type="text" id="edit_nama_ruang"
                        class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="mb-3"><label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapasitas</label><input
                        type="number" id="edit_kapasitas" class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="mb-3"><label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi</label><input type="text"
                        id="edit_lokasi" class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeEditRoomModal()"
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Batal</button><button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button></div>
            </form>
        </div>
    </div>

    <div id="editToolModal" class="hidden fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeEditToolModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Edit Data Barang</h3>
            <form id="form-edit-alat"><input type="hidden" id="edit_alat_id">
                <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama
                        Barang</label><input type="text" id="edit_nama_alat"
                        class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="mb-3"><label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenis</label><select
                        id="edit_jenis" class="w-full p-2 border rounded bg-gray-50">
                        <option value="alat">üõ†Ô∏è Alat</option>
                        <option value="bahan">üíß Bahan</option>
                    </select></div>
                <div class="mb-3"><label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label><input type="text"
                        id="edit_kategori" class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total
                        Stok</label><input type="number" id="edit_jumlah_total"
                        class="w-full p-2 border rounded bg-gray-50" required></div>
                <div class="mb-3"><label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Kondisi</label><select
                        id="edit_kondisi" class="w-full p-2 border rounded bg-gray-50">
                        <option value="baik">Baik</option>
                        <option value="rusak">Rusak</option>
                        <option value="maintenance">Maintenance</option>
                    </select></div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeEditToolModal()"
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Batal</button><button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button></div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://sil-lab-backend.vercel.app/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') { alert('Akses Ditolak!'); window.location.href = 'index.html'; }
        document.getElementById('adminName').innerText = user.nama || user.email || 'Admin';

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('bg-blue-600', 'text-white', 'shadow-md'); b.classList.add('text-gray-600', 'hover:bg-gray-100'); });
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-600', 'text-white', 'shadow-md');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:bg-gray-100');
            if (tabName === 'dashboard') loadAnalytics();
        }

        async function loadAnalytics() {
            try {
                const res = await fetch(`${API_URL}/analytics`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                document.getElementById('stat-admin').innerText = data.countAdmin;
                document.getElementById('stat-user').innerText = data.countUser;
                document.getElementById('stat-pending').innerText = data.pendingBookings;
                document.getElementById('stat-damage').innerText = data.damageReports;
                const ctxType = document.getElementById('typeChart').getContext('2d');
                if (window.typeChartInstance) window.typeChartInstance.destroy();
                window.typeChartInstance = new Chart(ctxType, { type: 'pie', data: { labels: ['Jadwal Kuliah', 'Peminjaman Mhs'], datasets: [{ data: [data.countAdmin, data.countUser], backgroundColor: ['#6366F1', '#10B981'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
                const roomLabels = [], roomCounts = {}, roomMap = {};
                if (data.roomUsage && data.roomUsage.length > 0) {
                    data.roomUsage.forEach(i => { const n = i.ruangan ? i.ruangan.nama_ruang : 'Tanpa Ruangan'; roomMap[n] = (roomMap[n] || 0) + 1; });
                    for (const k in roomMap) { roomLabels.push(k); roomCounts[k] = roomMap[k]; }
                    if (window.roomChartInstance) window.roomChartInstance.destroy();
                    document.getElementById('roomChartEmpty').classList.add('hidden');
                    const ctx = document.getElementById('roomChart').getContext('2d');
                    window.roomChartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(roomMap), datasets: [{ label: 'Pemakaian', data: Object.values(roomMap), backgroundColor: '#3B82F6' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
                } else { document.getElementById('roomChartEmpty').classList.remove('hidden'); }
                const toolLabels = [], toolCounts = [];
                if (data.toolUsage && data.toolUsage.length > 0) {
                    const toolMap = {}; data.toolUsage.forEach(t => { const n = t.peralatan?.nama_alat || 'Unknown'; toolMap[n] = (toolMap[n] || 0) + t.jumlah_pinjam; });
                    const sorted = Object.entries(toolMap).sort(([, a], [, b]) => b - a).slice(0, 5);
                    sorted.forEach(([n, c]) => { toolLabels.push(n); toolCounts.push(c); });
                    if (window.toolChartInstance) window.toolChartInstance.destroy();
                    document.getElementById('toolChartEmpty').classList.add('hidden');
                    const ctxT = document.getElementById('toolChart').getContext('2d');
                    window.toolChartInstance = new Chart(ctxT, { type: 'doughnut', data: { labels: toolLabels, datasets: [{ data: toolCounts, backgroundColor: ['#F59E0B', '#10B981', '#EF4444', '#3B82F6', '#8B5CF6'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                } else { document.getElementById('toolChartEmpty').classList.remove('hidden'); }
            } catch (e) { console.log(e); }
        }

        function exportToCSV() { fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } }).then(res => res.json()).then(data => { let csv = "data:text/csv;charset=utf-8,Nama Peminjam,Role,Ruangan,Alat,Tujuan,Mulai,Selesai,Status\n"; data.forEach(r => { let tools = '-'; if (r.peminjaman_detail_alat && r.peminjaman_detail_alat.length > 0) { tools = r.peminjaman_detail_alat.map(t => `${t.jumlah_pinjam}x ${t.peralatan?.nama_alat}`).join('; ').replace(/,/g, ' '); } const userName = (r.users?.nama || 'Admin').replace(/,/g, ' '); const role = r.users?.role || '-'; const room = (r.ruangan?.nama_ruang || 'Hanya Alat').replace(/,/g, ' '); const purpose = (r.tujuan_peminjaman || '').replace(/,/g, ' ').replace(/\n/g, ' '); csv += `${userName},${role},${room},${tools},${purpose},${new Date(r.waktu_mulai).toLocaleString()},${new Date(r.waktu_selesai).toLocaleString()},${r.status}\n`; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "laporan_peminjaman.csv"); document.body.appendChild(link); link.click(); }); }
        function exportEquipmentCSV() { fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } }).then(res => res.json()).then(data => { let csv = "data:text/csv;charset=utf-8,Nama Alat,Kategori,Total Stok,Stok Tersedia,Kondisi\n"; data.forEach(r => { csv += `${r.nama_alat},${r.kategori},${r.jumlah_total},${r.jumlah_tersedia},${r.kondisi}\n`; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "laporan_alat.csv"); document.body.appendChild(link); link.click(); }); }
        async function deleteItem(endpoint, id, confirmMsg, refreshFn) { if (!confirm(confirmMsg)) return; try { const res = await fetch(`${API_URL}/${endpoint}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); if (res.ok) { alert('Berhasil dihapus!'); refreshFn(); } else { alert('Gagal menghapus.'); } } catch (e) { alert(e.message); } }
        function toggleRepeatInput() { const isChecked = document.getElementById('is_repeat').checked; document.getElementById('repeat_input_container').className = isChecked ? 'mt-2' : 'hidden mt-2'; }
        async function loadRuangOptions() { const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); const s = document.getElementById('jadwal_ruang_id'); s.innerHTML = '<option value="">-- Pilih Ruangan --</option>'; data.forEach(r => { if (r.status !== 'maintenance') s.innerHTML += `<option value="${r.id}">${r.nama_ruang}</option>` }); }

        // --- LOAD ALL BOOKINGS ---
        async function loadAllBookings() {
            const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json();
            const pendingBody = document.getElementById('pendingTableBody'); const approvedBody = document.getElementById('approvedTableBody');
            pendingBody.innerHTML = ''; approvedBody.innerHTML = '';
            const pendingData = data.filter(i => i.status === 'pending'); const approvedData = data.filter(i => i.status !== 'pending');
            if (pendingData.length === 0) pendingBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center italic text-gray-400">Tidak ada permintaan baru</td></tr>';
            pendingData.forEach(item => {
                let info = item.ruangan ? `<div class="font-bold text-blue-600">üìç ${item.ruangan.nama_ruang}</div>` : `<div class="font-bold text-purple-600">üì¶ Peminjaman Alat</div>`;
                if (item.peminjaman_detail_alat?.length > 0) info += `<div class="text-xs text-gray-500 mt-1">Alat: ${item.peminjaman_detail_alat.map(t => t.jumlah_pinjam + 'x ' + t.peralatan?.nama_alat).join(', ')}</div>`;
                const start = new Date(item.waktu_mulai).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
                const end = new Date(item.waktu_selesai).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                pendingBody.innerHTML += `<tr class="bg-yellow-50 border-b border-yellow-100"><td class="p-3"><div class="font-bold text-gray-800">${item.users?.nama || 'User'}</div></td><td class="p-3 text-xs"><div class="font-medium text-gray-800">${item.tujuan_peminjaman}</div>${info}<div class="mt-1 text-gray-600">üìÖ ${start} s/d ${end}</div></td><td class="p-3 text-center space-x-1"><button onclick="updateStatus('${item.id}', 'disetujui')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 shadow">‚úì Terima</button><button onclick="updateStatus('${item.id}', 'ditolak')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 shadow">‚úï Tolak</button></td></tr>`;
            });
            const groups = {}; approvedData.forEach(item => { const baseName = item.tujuan_peminjaman.split(' (Pert.')[0]; const key = baseName + '_' + (item.ruang_id || 'toolonly'); if (!groups[key]) groups[key] = []; groups[key].push(item); });
            for (const key in groups) {
                const items = groups[key]; items.sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));
                const first = items[0]; const baseName = first.tujuan_peminjaman.split(' (Pert.')[0]; const groupId = 'group-' + Math.random().toString(36).substr(2, 9);
                let headerText = '‚ö†Ô∏è Tanpa Ruangan'; if (first.ruangan) headerText = first.ruangan.nama_ruang; else if (first.peminjaman_detail_alat?.length > 0) headerText = 'üì¶ Peminjaman Alat';
                const peminjamName = first.users?.nama || 'Admin/System';
                let labelType = first.users?.role === 'admin' ? `<span class="ml-2 bg-indigo-100 text-indigo-800 text-xs px-2 py-0.5 rounded-full border border-indigo-200 font-bold">üìÖ Kuliah</span>` : `<span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full border border-green-200 font-bold">üôã User</span>`;
                approvedBody.innerHTML += `<tr class="bg-white border-b hover:bg-slate-50 transition cursor-pointer" onclick="toggleGroup('${groupId}')"><td class="p-3 text-center text-gray-400 font-bold text-lg transition-transform transform" id="icon-${groupId}">‚ñ∂</td><td class="p-3 font-bold text-gray-800">${baseName}<span class="text-xs text-gray-400 ml-1">(${items.length} Sesi)</span> ${labelType}</td><td class="p-3 text-sm font-semibold text-blue-700">${peminjamName}</td><td class="p-3 text-sm text-gray-600">${headerText}</td><td class="p-3 text-xs text-gray-500">Mulai: ${new Date(items[0].waktu_mulai).toLocaleDateString()}</td><td class="p-3 text-center"><button onclick="event.stopPropagation(); deleteBatch('${baseName}', '${first.ruang_id || 'null'}')" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded bg-red-50">Hapus Semua</button></td></tr>`;
                let childRows = `<tr id="${groupId}" class="hidden-row bg-slate-50 shadow-inner"><td colspan="6" class="p-0"><table class="w-full">`;
                items.forEach(sub => {
                    let toolInfo = sub.peminjaman_detail_alat?.length > 0 ? `<br><span class="text-gray-400 italic">Alat: ${sub.peminjaman_detail_alat.map(t => t.jumlah_pinjam + 'x ' + t.peralatan?.nama_alat).join(', ')}</span>` : '';
                    const subStart = new Date(sub.waktu_mulai).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    const subEnd = new Date(sub.waktu_selesai).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    const subPeminjam = sub.users?.nama || '-';
                    childRows += `<tr class="border-b border-gray-200 text-xs text-gray-600 hover:bg-gray-100"><td class="p-3 pl-12 w-1/3 font-medium">${sub.tujuan_peminjaman} ${toolInfo}</td><td class="p-3 w-1/6 text-gray-500">${subPeminjam}</td><td class="p-3 w-1/6 text-gray-500">-</td><td class="p-3 w-1/4">${subStart} s/d ${subEnd}</td><td class="p-3 text-center w-24"><button onclick="deleteItem('booking', '${sub.id}', 'Hapus pertemuan ini saja?', loadAllBookings)" class="text-red-400 hover:text-red-600 underline">Hapus</button></td></tr>`;
                });
                approvedBody.innerHTML += childRows + `</table></td></tr>`;
            }
        }

        function toggleGroup(id) { const row = document.getElementById(id); const icon = document.getElementById('icon-' + id); if (row.classList.contains('hidden-row')) { row.classList.remove('hidden-row'); icon.style.transform = 'rotate(90deg)'; } else { row.classList.add('hidden-row'); icon.style.transform = 'rotate(0deg)'; } }
        async function deleteBatch(className, roomId) { if (!confirm(`‚ö†Ô∏è BAHAYA: Hapus SEMUA jadwal "${className}"?`)) return; try { const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); const toDel = data.filter(i => { const name = i.tujuan_peminjaman.split(' (Pert.')[0]; const itemRoomId = i.ruang_id || 'null'; return name === className && itemRoomId === roomId && i.status !== 'pending'; }); for (const i of toDel) await fetch(`${API_URL}/booking/${i.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); alert(`Berhasil.`); loadAllBookings(); } catch (e) { alert('Gagal batch delete'); } }
        async function handleTambahJadwal(e) { e.preventDefault(); const ruangId = document.getElementById('jadwal_ruang_id').value; if (!ruangId) { alert("‚ö†Ô∏è Mohon pilih ruangan!"); return; } const payload = { ruang_id: ruangId, waktu_mulai: new Date(document.getElementById('jadwal_mulai').value).toISOString(), waktu_selesai: new Date(document.getElementById('jadwal_selesai').value).toISOString(), tujuan_peminjaman: document.getElementById('jadwal_tujuan').value, is_repeat: document.getElementById('is_repeat').checked, repeat_count: document.getElementById('is_repeat').checked ? parseInt(document.getElementById('repeat_count').value) : 1 }; const btn = e.target.querySelector('button'); const oldText = btn.innerText; btn.innerText = 'Memproses...'; btn.disabled = true; try { const res = await fetch(`${API_URL}/booking/admin`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) }); const r = await res.json(); if (res.ok) { alert('Sukses'); e.target.reset(); document.getElementById('repeat_input_container').classList.add('hidden'); loadAllBookings(); } else { alert('Gagal: ' + r.error); } } catch (err) { alert('Gagal: ' + err.message); } finally { btn.innerText = oldText; btn.disabled = false; } }
        async function updateStatus(id, status) { await fetch(`${API_URL}/booking/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status }) }); loadAllBookings(); }
        async function loadRuangan() { const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); document.getElementById('table-ruangan-body').innerHTML = data.map(i => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-6 font-bold text-gray-800">${i.nama_ruang}</td><td class="py-3 px-6">${i.status === 'maintenance' ? '<span class="bg-orange-100 text-orange-800 px-2 rounded text-xs">MTC</span>' : '<span class="bg-green-100 text-green-800 px-2 rounded text-xs">OK</span>'}</td><td class="py-3 px-6 text-center"><div class="flex justify-center space-x-2"><button onclick="showRoomSchedule('${i.id}','${i.nama_ruang}')" class="text-blue-600 text-xs underline">Jadwal</button><button onclick="setMaintenance('${i.id}', '${i.status === 'maintenance' ? 'tersedia' : 'maintenance'}')" class="text-orange-500 text-xs underline">Status</button><button onclick="openEditRoomModal('${i.id}','${i.nama_ruang}','${i.kapasitas}','${i.lokasi}')" class="text-blue-600 text-xs font-bold border border-blue-200 px-2 py-1 rounded hover:bg-blue-50">Edit</button><button onclick="deleteItem('rooms','${i.id}','Hapus?',loadRuangan)" class="text-red-500 text-lg">&times;</button></div></td></tr>`).join(''); }
        async function setMaintenance(id, s) { if (confirm('Ubah status?')) await fetch(`${API_URL}/rooms/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status: s }) }); loadRuangan(); loadRuangOptions(); }
        async function handleTambahRuang(e) { e.preventDefault(); await fetch(`${API_URL}/rooms`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ nama_ruang: document.getElementById('nama_ruang').value, kapasitas: document.getElementById('kapasitas').value, lokasi: document.getElementById('lokasi').value }) }); e.target.reset(); loadRuangan(); loadRuangOptions(); }
        function openEditRoomModal(id, nama, kap, lok) { document.getElementById('edit_room_id').value = id; document.getElementById('edit_nama_ruang').value = nama; document.getElementById('edit_kapasitas').value = kap; document.getElementById('edit_lokasi').value = lok; document.getElementById('editRoomModal').classList.remove('hidden'); }
        function closeEditRoomModal() { document.getElementById('editRoomModal').classList.add('hidden'); }
        document.getElementById('form-edit-ruangan').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('edit_room_id').value; const payload = { nama_ruang: document.getElementById('edit_nama_ruang').value, kapasitas: document.getElementById('edit_kapasitas').value, lokasi: document.getElementById('edit_lokasi').value }; try { const res = await fetch(`${API_URL}/rooms/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) }); if (res.ok) { alert('Berhasil diupdate!'); closeEditRoomModal(); loadRuangan(); } else { alert('Gagal update.'); } } catch (e) { alert('Error: ' + e.message); } });

        // --- 2. LOAD PERALATAN (With "Jenis" Badge Logic) ---
        let activeLoans = [];
        async function loadPeralatan() {
            try {
                const resAlat = await fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } });
                const dataAlat = await resAlat.json();
                const resLoans = await fetch(`${API_URL}/booking/active-tools`, { headers: { 'Authorization': `Bearer ${token}` } });
                activeLoans = await resLoans.json();
                const tbody = document.getElementById('table-peralatan-body');
                tbody.innerHTML = '';

                dataAlat.forEach(item => {
                    // HITUNG YANG DIPINJAM (Hanya jika jenisnya 'alat')
                    // Jika 'bahan', activeLoans tidak relevan karena stok sudah dipotong permanen
                    const loansForItem = activeLoans.filter(loan => loan.alat_id === item.id && item.jenis === 'alat');
                    const totalBorrowed = loansForItem.reduce((sum, loan) => sum + loan.jumlah_pinjam, 0);

                    const sisa = item.jumlah_total - totalBorrowed;
                    const sisaColor = sisa === 0 ? 'text-red-600 font-bold' : (sisa < 5 ? 'text-orange-500 font-bold' : 'text-green-600');

                    // Tombol 'Dipinjam' hanya relevan untuk Alat
                    const btnPeminjam = item.jenis === 'alat' && totalBorrowed > 0
                        ? `<button onclick="showBorrowers('${item.id}', '${item.nama_alat}')" class="text-blue-600 hover:underline font-bold">${totalBorrowed}</button>`
                        : `<span class="text-gray-400">0</span>`;

                    const jenisBadge = item.jenis === 'bahan'
                        ? '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs border border-purple-200">üíß Bahan</span>'
                        : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs border border-blue-200">üõ†Ô∏è Alat</span>';

                    const btnEdit = `<button onclick="openEditToolModal('${item.id}', '${item.nama_alat}', '${item.kategori}', '${item.jumlah_total}', '${item.kondisi}', '${item.jenis}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs border border-blue-200 px-2 py-1 rounded mr-2">Edit</button>`;

                    tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="py-3 px-6"><div class="font-bold text-gray-800">${item.nama_alat}</div><div class="text-xs text-gray-500">${item.kategori}</div></td>
                        <td class="py-3 px-6 text-center">${jenisBadge}</td>
                        <td class="py-3 px-6 text-center">${item.jumlah_total}</td>
                        <td class="py-3 px-6 text-center text-lg">${btnPeminjam}</td>
                        <td class="py-3 px-6 text-center ${sisaColor}">${sisa}</td>
                        <td class="py-3 px-6 text-center flex justify-center items-center pt-4">
                            ${btnEdit}
                            <button onclick="deleteItem('equipment', '${item.id}', 'Hapus barang ini?', loadPeralatan)" class="text-red-500 hover:text-red-700 text-lg" title="Hapus">&times;</button>
                        </td>
                    </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        async function handleTambahPeralatan(e) { e.preventDefault(); await fetch(`${API_URL}/equipment`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ nama_alat: document.getElementById('nama_alat').value, jenis: document.getElementById('jenis_alat').value, kategori: document.getElementById('kategori').value, jumlah_total: document.getElementById('jumlah_total').value, kondisi: document.getElementById('kondisi').value }) }); e.target.reset(); loadPeralatan(); }
        function openEditToolModal(id, nama, kat, tot, kond, jenis) { document.getElementById('edit_alat_id').value = id; document.getElementById('edit_nama_alat').value = nama; document.getElementById('edit_kategori').value = kat; document.getElementById('edit_jumlah_total').value = tot; document.getElementById('edit_kondisi').value = kond; document.getElementById('edit_jenis').value = jenis || 'alat'; document.getElementById('editToolModal').classList.remove('hidden'); }
        function closeEditToolModal() { document.getElementById('editToolModal').classList.add('hidden'); }
        document.getElementById('form-edit-alat').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('edit_alat_id').value; const payload = { nama_alat: document.getElementById('edit_nama_alat').value, jenis: document.getElementById('edit_jenis').value, kategori: document.getElementById('edit_kategori').value, jumlah_total: document.getElementById('edit_jumlah_total').value, kondisi: document.getElementById('edit_kondisi').value }; try { const res = await fetch(`${API_URL}/equipment/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) }); if (res.ok) { alert('Data alat berhasil diupdate!'); closeEditToolModal(); loadPeralatan(); } else { alert('Gagal update.'); } } catch (e) { alert('Error: ' + e.message); } });

        function showBorrowers(alatId, alatName) { document.getElementById('modalToolName').innerText = `Peminjam: ${alatName}`; const list = document.getElementById('borrowerList'); list.innerHTML = ''; const loans = activeLoans.filter(loan => loan.alat_id === alatId); loans.forEach(l => { list.innerHTML += `<div class="bg-gray-50 p-3 rounded border border-gray-200 flex justify-between items-center mb-2"><div><div class="font-bold text-gray-800">${l.peminjaman.users?.nama || 'Unknown'}</div><div class="text-xs text-gray-500">üìÖ ${new Date(l.peminjaman.waktu_mulai).toLocaleDateString()}</div></div><div class="font-bold text-xl text-blue-800 bg-blue-100 px-3 py-1 rounded">${l.jumlah_pinjam}</div></div>`; }); document.getElementById('borrowerModal').classList.remove('hidden'); }
        function closeBorrowerModal() { document.getElementById('borrowerModal').classList.add('hidden'); }
        async function loadReports() { const res = await fetch(`${API_URL}/reports/all`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); const b = document.getElementById('table-reports-body'); b.innerHTML = ''; if (data.length === 0) b.innerHTML = '<tr><td colspan="5" class="text-center py-4">Tidak ada laporan.</td></tr>'; else data.forEach(i => { b.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="py-3 px-6 text-xs">${new Date(i.tanggal_lapor).toLocaleDateString()}</td><td class="py-3 px-6 font-bold">${i.users?.nama || 'User'}</td><td class="py-3 px-6 text-blue-600">${i.peralatan?.nama_alat || '-'}</td><td class="py-3 px-6 text-xs truncate max-w-xs" title="${i.deskripsi_kerusakan}">${i.deskripsi_kerusakan}</td><td class="py-3 px-6 text-center"><select onchange="updateReportStatus('${i.id}',this.value)" class="border rounded text-xs"><option value="baru" ${i.status_laporan === 'baru' ? 'selected' : ''}>Baru</option><option value="diproses" ${i.status_laporan === 'diproses' ? 'selected' : ''}>Diproses</option><option value="selesai" ${i.status_laporan === 'selesai' ? 'selected' : ''}>Selesai</option></select></td></tr>` }); }
        async function updateReportStatus(id, s) { if (confirm('Update status?')) await fetch(`${API_URL}/reports/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status_laporan: s }) }); loadReports(); }

        // --- 3. SHOW ROOM SCHEDULE (FIXED: GROUPING, ROLE, & ACCORDION) ---
        function toggleDetail(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('chevron-' + id.split('-')[1]);
            if (el.classList.contains('hidden')) { el.classList.remove('hidden'); if (icon) icon.classList.add('rotate-180'); }
            else { el.classList.add('hidden'); if (icon) icon.classList.remove('rotate-180'); }
        }

        function toggleModal() { document.getElementById('scheduleModal').classList.toggle('hidden'); }

        async function showRoomSchedule(roomId, roomName) {
            document.getElementById('modalRoomName').innerText = `Jadwal: ${roomName}`;
            const list = document.getElementById('modalScheduleList');
            const empty = document.getElementById('modalEmpty');
            list.innerHTML = '<li class="text-center py-4 text-gray-500"><i class="fas fa-circle-notch fa-spin"></i> Memuat data...</li>';
            empty.classList.add('hidden');
            toggleModal();

            try {
                const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } });
                const allBookings = await res.json();

                const roomSched = allBookings
                    .filter(s => s.ruang_id === roomId && s.status === 'disetujui')
                    .sort((a, b) => new Date(a.waktu_mulai) - new Date(b.waktu_mulai));

                list.innerHTML = '';

                if (roomSched.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    let lastDate = '';

                    roomSched.forEach(s => {
                        const dateObj = new Date(s.waktu_mulai);
                        const dateHeader = dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        const startTime = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                        const endTime = new Date(s.waktu_selesai).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                        const user = s.users ? s.users.nama : 'System';
                        const purpose = s.tujuan_peminjaman || '-';
                        const detailId = `detail-${s.id}`;

                        // --- ROLE MAPPING ---
                        const rawRole = s.users?.role ? s.users.role.toLowerCase() : '';
                        let displayRole = 'Mahasiswa';
                        let badgeColor = 'bg-green-100 text-green-800 border-green-200';

                        if (rawRole === 'admin') { displayRole = 'Admin'; badgeColor = 'bg-indigo-100 text-indigo-800 border-indigo-200'; }
                        else if (rawRole === 'dosen') { displayRole = 'Dosen'; badgeColor = 'bg-blue-100 text-blue-800 border-blue-200'; }
                        else if (rawRole === 'asisten') { displayRole = 'Asisten'; badgeColor = 'bg-purple-100 text-purple-800 border-purple-200'; }

                        if (dateHeader !== lastDate) {
                            list.innerHTML += `<li class="sticky-date bg-slate-100 px-3 py-2 font-bold text-gray-700 text-sm rounded-md mb-2 shadow-sm border border-slate-200 z-10 mt-3">üìÖ ${dateHeader}</li>`;
                            lastDate = dateHeader;
                        }

                        let toolsInfo = '';
                        if (s.peminjaman_detail_alat && s.peminjaman_detail_alat.length > 0) {
                            toolsInfo = `<div class="mt-2 pt-2 border-t border-dashed border-gray-200 text-xs text-purple-700"><i class="fas fa-tools mr-1"></i> <b>Alat:</b> ` + s.peminjaman_detail_alat.map(t => `${t.jumlah_pinjam}x ${t.peralatan?.nama_alat}`).join(', ') + `</div>`;
                        }

                        list.innerHTML += `
                            <li onclick="toggleDetail('${detailId}')" class="bg-white border-l-4 ${rawRole === 'admin' ? 'border-indigo-500' : 'border-green-500'} pl-3 pr-3 py-3 mb-3 rounded shadow-sm cursor-pointer hover:bg-slate-50 transition relative">
                                <div class="flex justify-between items-center">
                                    <div class="w-full">
                                        <div class="flex justify-between w-full mb-1 items-center">
                                            <span class="font-bold text-gray-800 text-sm">${startTime} - ${endTime}</span>
                                            <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full border ${badgeColor}">${user.split(' ')[0].substring(0, 8)}..</span>
                                        </div>
                                        <div class="text-xs text-gray-500 truncate w-11/12">${purpose}</div>
                                    </div>
                                    <div class="ml-2 text-gray-400"><i id="chevron-${s.id}" class="fas fa-chevron-down text-xs transition-transform duration-300"></i></div>
                                </div>
                                <div id="${detailId}" class="hidden mt-3 pt-2 text-sm bg-slate-50 -mx-3 -mb-3 px-3 py-2 rounded-b border-t border-slate-100">
                                    <p class="text-gray-700 text-xs mb-1"><span class="font-bold">Peminjam:</span> ${user} <span class="text-gray-500 italic">(${displayRole})</span></p>
                                    <p class="text-gray-700 text-xs"><span class="font-bold">Kegiatan:</span> ${purpose}</p>
                                    ${toolsInfo}
                                </div>
                            </li>`;
                    });
                }
            } catch (e) {
                console.error(e);
                list.innerHTML = '<li class="text-center text-red-500">Gagal memuat jadwal.</li>';
            }
        }

        function logout() {
            Swal.fire({
                title: 'Keluar?', text: "Anda yakin ingin keluar?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Keluar'
            }).then((result) => { if (result.isConfirmed) { localStorage.clear(); window.location.href = 'index.html'; } })
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('dashboard');
            loadAnalytics(); loadAllBookings(); loadRuangan(); loadPeralatan(); loadReports(); loadRuangOptions();
            document.getElementById('form-tambah-jadwal').addEventListener('submit', handleTambahJadwal);
            document.getElementById('form-tambah-ruang').addEventListener('submit', handleTambahRuang);
            document.getElementById('form-tambah-peralatan').addEventListener('submit', handleTambahPeralatan);
        });
    </script>
</body>

</html>