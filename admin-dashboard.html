<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SIL Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sembunyikan tab content secara default */
        .tab-content { display: none; }
        /* Tampilkan tab content yang aktif */
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Navbar Admin -->
    <nav class="bg-gray-900 p-4 text-white flex justify-between items-center shadow-lg">
        <h1 class="font-bold text-xl tracking-wide">ADMIN PANEL SIL</h1>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition">Keluar</button>
    </nav>

    <div class="container mx-auto p-6">
        
        <!-- Navigasi Tab -->
        <div class="mb-6 bg-white rounded-lg shadow-sm">
            <nav class="flex space-x-1 p-2">
                <button onclick="showTab('peminjaman')" id="tab-peminjaman" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-medium text-center bg-blue-600 text-white">
                    Manajemen Peminjaman
                </button>
                <button onclick="showTab('ruangan')" id="tab-ruangan" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-medium text-center text-gray-600 hover:bg-gray-200">
                    Manajemen Ruangan
                </button>
                <button onclick="showTab('peralatan')" id="tab-peralatan" class="tab-button flex-1 py-3 px-4 rounded-md text-sm font-medium text-center text-gray-600 hover:bg-gray-200">
                    Manajemen Peralatan
                </button>
            </nav>
        </div>

        <!-- === KONTEN TAB 1: PEMINJAMAN (KODE LAMA ANDA) === -->
        <div id="content-peminjaman" class="tab-content active">
            <h2 class="text-2xl font-bold mb-6">Daftar Permintaan Peminjaman</h2>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-200 text-gray-600 text-sm uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left">Peminjam</th>
                                <th class="py-3 px-6 text-left">Ruangan</th>
                                <th class="py-3 px-6 text-left">Waktu & Tujuan</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody" class="text-gray-600 text-sm font-light">
                            <!-- Data Peminjaman dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- === KONTEN TAB 2: MANAJEMEN RUANGAN (BARU) === -->
        <div id="content-ruangan" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Manajemen Data Ruangan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Form Tambah Ruangan -->
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit">
                    <h3 class="text-lg font-semibold mb-4">Tambah Ruangan Baru</h3>
                    <form id="form-tambah-ruang">
                        <div class="mb-4">
                            <label for="nama_ruang" class="block text-sm font-medium text-gray-700">Nama Ruang</label>
                            <input type="text" id="nama_ruang" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="kapasitas" class="block text-sm font-medium text-gray-700">Kapasitas</label>
                            <input type="number" id="kapasitas" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="lokasi" class="block text-sm font-medium text-gray-700">Lokasi (Gedung/Lantai)</label>
                            <input type="text" id="lokasi" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan Ruangan</button>
                    </form>
                </div>
                <!-- Tabel Daftar Ruangan -->
                <div class="md:col-span-2 bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-200 text-gray-600 text-sm uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left">Nama Ruang</th>
                                <th class="py-3 px-6 text-left">Kapasitas</th>
                                <th class="py-3 px-6 text-left">Lokasi</th>
                            </tr>
                        </thead>
                        <tbody id="table-ruangan-body" class="text-gray-600 text-sm">
                            <!-- Data Ruangan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- === KONTEN TAB 3: MANAJEMEN PERALATAN (BARU) === -->
        <div id="content-peralatan" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Manajemen Data Peralatan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Form Tambah Peralatan -->
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow h-fit">
                    <h3 class="text-lg font-semibold mb-4">Tambah Peralatan Baru</h3>
                    <form id="form-tambah-peralatan">
                        <div class="mb-4">
                            <label for="nama_alat" class="block text-sm font-medium text-gray-700">Nama Alat</label>
                            <input type="text" id="nama_alat" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                            <input type="text" id="kategori" placeholder="Contoh: Mikroskop, Komputer" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="jumlah_total" class="block text-sm font-medium text-gray-700">Jumlah Total</label>
                            <input type="number" id="jumlah_total" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="kondisi" class="block text-sm font-medium text-gray-700">Kondisi</label>
                            <select id="kondisi" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option value="baik">Baik</option>
                                <option value="rusak">Rusak</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan Alat</button>
                    </form>
                </div>
                <!-- Tabel Daftar Peralatan -->
                <div class="md:col-span-2 bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-200 text-gray-600 text-sm uppercase">
                            <tr>
                                <th class="py-3 px-6 text-left">Nama Alat</th>
                                <th class="py-3 px-6 text-left">Kategori</th>
                                <th class="py-3 px-6 text-center">Total</th>
                                <th class="py-3 px-6 text-center">Kondisi</th>
                            </tr>
                        </thead>
                        <tbody id="table-peralatan-body" class="text-gray-600 text-sm">
                            <!-- Data Peralatan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- KONFIGURASI ---
        const API_URL = 'https://sil-lab-backend.vercel.app/api'; 
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // --- FUNGSI TAB ---
        function showTab(tabName) {
            // Sembunyikan semua konten
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Hapus style aktif dari semua tombol
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('text-gray-600', 'hover:bg-gray-200');
            });
            
            // Tampilkan konten yang dipilih
            document.getElementById(`content-${tabName}`).classList.add('active');
            // Beri style aktif pada tombol yang dipilih
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('bg-blue-600', 'text-white');
            activeButton.classList.remove('text-gray-600', 'hover:bg-gray-200');
        }

        // --- OTENTIKASI ---
        if (!token || user.role !== 'admin') {
            alert('Akses Ditolak! Anda bukan Admin.');
            window.location.href = 'index.html';
        }

        // --- DATA PEMINJAMAN (KODE LAMA) ---
        async function loadAllBookings() {
            try {
                const res = await fetch(`${API_URL}/booking`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const tableBody = document.getElementById('adminTableBody');
                tableBody.innerHTML = '';
                data.forEach(item => {
                    let statusColor = 'bg-yellow-100 text-yellow-800';
                    if(item.status === 'disetujui') statusColor = 'bg-green-100 text-green-800';
                    if(item.status === 'ditolak') statusColor = 'bg-red-100 text-red-800';
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">${item.users?.nama || 'Unknown'}</td>
                            <td class="py-3 px-4">${item.ruangan?.nama_ruang || item.ruang_id}</td>
                            <td class="py-3 px-4 text-sm">${new Date(item.waktu_mulai).toLocaleString()}</td>
                            <td class="py-3 px-4 text-center"><span class="${statusColor} px-2 py-1 rounded text-xs font-bold">${item.status.toUpperCase()}</span></td>
                            <td class="py-3 px-4 text-center">${item.status === 'pending' ? `<button onclick="updateStatus('${item.id}', 'disetujui')" class="text-green-500">Terima</button> <button onclick="updateStatus('${item.id}', 'ditolak')" class="text-red-500">Tolak</button>` : 'Selesai'}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (error) { console.error(error); }
        }
        async function updateStatus(id, status) {
            if(!confirm(`Yakin ${status}?`)) return;
            await fetch(`${API_URL}/booking/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status })
            });
            loadAllBookings();
        }

        // --- DATA RUANGAN (BARU) ---
        async function loadRuangan() {
            try {
                const res = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const tableBody = document.getElementById('table-ruangan-body');
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-6">${item.nama_ruang}</td>
                            <td class="py-3 px-6">${item.kapasitas} orang</td>
                            <td class="py-3 px-6">${item.lokasi}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (error) { console.error('Gagal load ruangan:', error); }
        }
        async function handleTambahRuang(e) {
            e.preventDefault();
            const payload = {
                nama_ruang: document.getElementById('nama_ruang').value,
                kapasitas: parseInt(document.getElementById('kapasitas').value),
                lokasi: document.getElementById('lokasi').value,
            };
            try {
                const res = await fetch(`${API_URL}/rooms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                
                // --- PERBAIKAN ERROR HANDLING ---
                if (!res.ok) {
                    // Jika response BUKAN JSON, lempar error HTTP
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errData = await res.json();
                        throw new Error(errData.error || 'Terjadi kesalahan');
                    } else {
                        throw new Error(`Server error: ${res.status} ${res.statusText}`);
                    }
                }
                // --- AKHIR PERBAIKAN ---

                alert('Ruangan berhasil ditambahkan!');
                document.getElementById('form-tambah-ruang').reset();
                loadRuangan();
            } catch (error) { 
                alert('Gagal menambah ruangan: ' + error.message); 
            }
        }

        // --- DATA PERALATAN (BARU) ---
        async function loadPeralatan() {
            try {
                const res = await fetch(`${API_URL}/equipment`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const tableBody = document.getElementById('table-peralatan-body');
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-6">${item.nama_alat}</td>
                            <td class="py-3 px-6">${item.kategori}</td>
                            <td class="py-3 px-6 text-center">${item.jumlah_total}</td>
                            <td class="py-3 px-6 text-center">${item.kondisi}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (error) { console.error('Gagal load peralatan:', error); }
        }
        async function handleTambahPeralatan(e) {
            e.preventDefault();
            const payload = {
                nama_alat: document.getElementById('nama_alat').value,
                kategori: document.getElementById('kategori').value,
                jumlah_total: parseInt(document.getElementById('jumlah_total').value),
                kondisi: document.getElementById('kondisi').value,
            };
            try {
                const res = await fetch(`${API_URL}/equipment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                // --- PERBAIKAN ERROR HANDLING ---
                if (!res.ok) {
                    // Jika response BUKAN JSON, lempar error HTTP
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errData = await res.json();
                        throw new Error(errData.error || 'Terjadi kesalahan');
                    } else {
                        throw new Error(`Server error: ${res.status} ${res.statusText}`);
                    }
                }
                // --- AKHIR PERBAIKAN ---

                alert('Peralatan berhasil ditambahkan!');
                document.getElementById('form-tambah-peralatan').reset();
                loadPeralatan();
            } catch (error) { alert('Gagal menambah peralatan: ' + error.message); }
        }

        // --- LOGOUT ---
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // --- INISIALISASI HALAMAN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Muat data untuk semua tab
            loadAllBookings();
            loadRuangan();
            loadPeralatan();

            // Tambahkan event listener untuk form baru
            document.getElementById('form-tambah-ruang').addEventListener('submit', handleTambahRuang);
            document.getElementById('form-tambah-peralatan').addEventListener('submit', handleTambahPeralatan);
        });
    </script>
</body>
</html>
