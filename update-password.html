<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Reset Password - SISIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Supabase Client langsung di Frontend agar sesi terjaga -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen font-sans">

    <div class="bg-white p-8 rounded-xl shadow-lg w-96">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-green-600">Password Baru</h2>
            <p class="text-xs text-gray-500 mt-1">Silakan masukkan password baru Anda.</p>
        </div>
        
        <form id="updateForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                <div class="relative">
                    <input type="password" id="password" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none pr-10" required>
                </div>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition">
                Simpan Password
            </button>
        </form>
        <p id="statusMsg" class="text-center text-sm mt-4 text-red-500"></p>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE DI FRONTEND (WAJIB UNTUK RESET PASSWORD) ---
        // Masukkan URL dan ANON KEY Supabase Anda di sini
        // Anda bisa menemukannya di Dashboard Supabase > Settings > API
        const SUPABASE_URL = 'https://dzphktxcddkrfmfrtpeo.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6cGhrdHhjZGRrcmZtZnJ0cGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0Mjk4NzksImV4cCI6MjA3OTAwNTg3OX0.qm4n2VoUZZtnV69RSWhw8oXatyW23ViDMlIJwKQf2dA';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- CEK SESI SAAT LOAD ---
        // Supabase otomatis mendeteksi hash token di URL dan membuat sesi
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                // User sedang dalam mode recovery, izinkan update
                console.log('Recovery mode active');
            }
        });

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('button');
            const msg = document.getElementById('statusMsg');
            
            btn.innerHTML = 'Menyimpan...'; btn.disabled = true;
            msg.innerText = '';

            try {
                // Update Password langsung via Supabase Client Frontend
                // Ini lebih aman karena token sesi dikelola otomatis oleh library
                const { data, error } = await supabase.auth.updateUser({ 
                    password: password 
                });

                if (error) throw error;

                alert('✅ Password Berhasil Diubah! Silakan Login dengan password baru.');
                window.location.href = 'index.html';

            } catch (error) {
                console.error(error);
                msg.innerText = 'Gagal: ' + error.message;
                alert('❌ Gagal: ' + error.message);
            } finally {
                btn.innerHTML = 'Simpan Password'; btn.disabled = false;
            }
        });
    </script>
</body>
</html>