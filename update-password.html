<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Reset Password - SISIL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body
    class="bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center h-screen font-sans relative overflow-hidden">
    <!-- Background Decoration -->
    <div
        class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-green-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
    </div>
    <div
        class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-emerald-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
    </div>
    <div
        class="absolute -bottom-32 left-20 w-96 h-96 bg-teal-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000">
    </div>

    <div
        class="bg-white/80 backdrop-blur-xl p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-sm border border-white/50 relative z-10 transition-all duration-300 min-h-[400px] flex flex-col justify-center">

        <div id="loadingState" class="text-center py-6">
            <div class="w-16 h-16 border-4 border-green-200 border-t-green-600 rounded-full animate-spin mx-auto mb-6">
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Memproses Token...</h3>
            <p class="text-sm text-gray-500" id="debugMsg">Menganalisis URL...</p>
        </div>

        <div id="formContainer" class="hidden">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">
                    <i class="fas fa-lock-open"></i>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-800 tracking-tight">Password Baru</h2>
                <p class="text-sm text-slate-500 mt-2 font-medium">Masukkan password baru Anda.</p>
            </div>

            <form id="updateForm" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 ml-1">Password
                        Baru</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fas fa-key text-gray-400 group-focus-within:text-green-500 transition-colors"></i>
                        </div>
                        <input type="password" id="password"
                            class="pl-11 pr-11 w-full p-3.5 bg-gray-50 border-transparent rounded-xl focus:bg-white focus:ring-2 focus:ring-green-500 focus:shadow-lg outline-none transition-all duration-300 shadow-sm font-medium text-slate-700"
                            placeholder="Minimal 6 karakter" required>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white p-3.5 rounded-xl font-bold transition-all shadow-lg shadow-green-500/30 transform active:scale-95 text-lg">
                    Simpan Password
                </button>
            </form>
        </div>

        <div id="errorState" class="hidden text-center py-6">
            <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-exclamation-triangle text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Akses Ditolak</h3>
            <div class="bg-red-50 text-red-600 text-xs px-4 py-3 rounded-xl border border-red-100 mb-6 font-medium"
                id="errorMsg">
                Token tidak valid.
            </div>
            <a href="forgot-password.html"
                class="inline-flex items-center gap-2 text-green-600 hover:text-green-800 font-bold transition hover:underline">
                <i class="fas fa-arrow-left"></i> Minta Link Baru
            </a>
        </div>
    </div>

    <script>
        // --- KONFIGURASI (GUNAKAN ANON KEY!) ---
        const SUPABASE_URL = 'https://dzphktxcddkrfmfrtpeo.supabase.co';
        // Ini harus ANON KEY (biasanya public)
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6cGhrdHhjZGRrcmZtZnJ0cGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0Mjk4NzksImV4cCI6MjA3OTAwNTg3OX0.qm4n2VoUZZtnV69RSWhw8oXatyW23ViDMlIJwKQf2dA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // UI Helpers
        const loadingEl = document.getElementById('loadingState');
        const formEl = document.getElementById('formContainer');
        const errorEl = document.getElementById('errorState');
        const debugMsg = document.getElementById('debugMsg');
        const errorMsg = document.getElementById('errorMsg');

        function showForm() {
            loadingEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            formEl.classList.remove('hidden');
        }

        function showError(msg) {
            loadingEl.classList.add('hidden');
            formEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorMsg.innerText = msg;
        }

        // --- LOGIKA UTAMA (DIRECT EXECUTION) ---
        async function runAuthCheck() {
            console.log("ðŸš€ Memulai pengecekan...");

            // 1. Ambil Token dari URL Hash (#access_token=...)
            // Kita potong tanda '#' di depan, lalu parse
            const hashString = window.location.hash.substring(1);
            const params = new URLSearchParams(hashString);

            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');
            const type = params.get('type');
            const errorDesc = params.get('error_description');

            // 2. Cek apakah ada Error dari Supabase langsung di URL
            if (errorDesc) {
                showError("Error dari Server: " + decodeURIComponent(errorDesc).replace(/\+/g, ' '));
                return;
            }

            // 3. JIKA TOKEN DITEMUKAN: LANGSUNG PAKAI (JANGAN TUNGGU LISTENER)
            if (accessToken) {
                debugMsg.innerText = "Token ditemukan. Memverifikasi...";
                console.log("Token ditemukan di URL, mencoba setSession...");

                try {
                    // Paksa Supabase pakai token ini
                    const { data, error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken || ""
                    });

                    if (error) {
                        throw error;
                    }

                    if (data.session) {
                        console.log("âœ… Session Valid!");
                        showForm(); // SUKSES!
                        return;
                    }
                } catch (err) {
                    console.error("Gagal set session:", err);
                    showError("Link rusak atau kadaluarsa: " + err.message);
                    return;
                }
            }

            // 4. Fallback: Cek jika browser sudah menyimpan sesi (misal user refresh)
            debugMsg.innerText = "Mengecek sesi tersimpan...";
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                console.log("âœ… Sesi tersimpan ditemukan.");
                showForm();
            } else {
                // Jika sampai sini tidak ada token dan tidak ada sesi -> ERROR
                console.warn("âŒ Tidak ada token di URL dan tidak ada sesi.");
                showError("Link tidak valid. Pastikan Anda menyalin seluruh link dari email.");
            }
        }

        // Jalankan Segera
        runAuthCheck();

        // --- HANDLE SUBMIT ---
        // Initialize Blobs Animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes blob {
                0% { transform: translate(0px, 0px) scale(1); }
                33% { transform: translate(30px, -50px) scale(1.1); }
                66% { transform: translate(-20px, 20px) scale(0.9); }
                100% { transform: translate(0px, 0px) scale(1); }
            }
            .animate-blob {
                animation: blob 7s infinite;
            }
            .animation-delay-2000 {
                animation-delay: 2s;
            }
            .animation-delay-4000 {
                animation-delay: 4s;
            }
        `;
        document.head.appendChild(style);

        // --- HANDLE SUBMIT ---
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan...';
            btn.opacity = 0.7;
            btn.disabled = true;

            const { error } = await supabase.auth.updateUser({ password: password });

            if (error) {
                Swal.fire({
                    title: 'Gagal',
                    text: error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
                btn.innerHTML = originalText;
                btn.opacity = 1;
                btn.disabled = false;
            } else {
                Swal.fire({
                    title: 'Berhasil! ðŸ”“',
                    text: 'Password Anda telah diperbarui. Silakan login.',
                    icon: 'success',
                    confirmButtonColor: '#059669'
                }).then(async () => {
                    await supabase.auth.signOut();
                    window.location.href = "index.html";
                });
            }
        });
    </script>
</body>

</html>